<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Nginx功能概述HTTP基础功能：  处理静态文件，索引文件以及自动索引； 反向代理加速(无缓存)，简单的负载均衡和容错； FastCGI，简单的负载均衡和容错； 模块化的结构。过滤器包括gzipping, byte ranges, chunked responses, 以及 SSI-filter 。在SSI过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理； SSL 和">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx功能及配置">
<meta property="og:url" content="http://example.com/2020/09/21/Nginx%E5%8A%9F%E8%83%BD%E5%8F%8A%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="地字第一号">
<meta property="og:description" content="Nginx功能概述HTTP基础功能：  处理静态文件，索引文件以及自动索引； 反向代理加速(无缓存)，简单的负载均衡和容错； FastCGI，简单的负载均衡和容错； 模块化的结构。过滤器包括gzipping, byte ranges, chunked responses, 以及 SSI-filter 。在SSI过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理； SSL 和">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-21T05:09:32.000Z">
<meta property="article:modified_time" content="2020-09-21T05:10:54.482Z">
<meta property="article:author" content="归海一刀">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2020/09/21/Nginx%E5%8A%9F%E8%83%BD%E5%8F%8A%E9%85%8D%E7%BD%AE/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nginx功能及配置 | 地字第一号</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="地字第一号" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地字第一号</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">重庆·嘉陵江·望江阁</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/09/21/Nginx%E5%8A%9F%E8%83%BD%E5%8F%8A%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="归海一刀">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地字第一号">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx功能及配置
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-21 13:09:32 / 修改时间：13:10:54" itemprop="dateCreated datePublished" datetime="2020-09-21T13:09:32+08:00">2020-09-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">服务</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Nginx功能概述"><a href="#Nginx功能概述" class="headerlink" title="Nginx功能概述"></a>Nginx功能概述</h1><p><strong><strong>HTTP基础功能：</strong></strong></p>
<ul>
<li>处理静态文件，索引文件以及自动索引；</li>
<li>反向代理加速(无缓存)，简单的负载均衡和容错；</li>
<li>FastCGI，简单的负载均衡和容错；</li>
<li>模块化的结构。过滤器包括gzipping, byte ranges, chunked responses, 以及 SSI-filter 。在SSI过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理；</li>
<li>SSL 和 TLS SNI 支持；</li>
</ul>
<p><strong><strong>IMAP/POP3 代理服务功能：</strong></strong></p>
<ul>
<li>使用外部 HTTP 认证服务器重定向用户到 IMAP/POP3 后端；</li>
<li>使用外部 HTTP 认证服务器认证用户后连接重定向到内部的 SMTP 后端；</li>
<li>认证方法：</li>
<li>POP3: POP3 USER/PASS, APOP, AUTH LOGIN PLAIN CRAM-MD5;</li>
<li>IMAP: IMAP LOGIN;</li>
<li>SMTP: AUTH LOGIN PLAIN CRAM-MD5;</li>
<li>SSL 支持；</li>
<li>在 IMAP 和 POP3 模式下的 STARTTLS 和 STLS 支持；</li>
</ul>
<p><strong><strong>支持的操作系统：</strong></strong></p>
<ul>
<li>FreeBSD 3.x, 4.x, 5.x, 6.x i386; FreeBSD 5.x, 6.x amd64;</li>
<li>Linux 2.2, 2.4, 2.6 i386; Linux 2.6 amd64;</li>
<li>Solaris 8 i386; Solaris 9 i386 and sun4u; Solaris 10 i386;</li>
<li>MacOS X (10.4) PPC;</li>
</ul>
<p><strong><strong>结构与扩展：</strong></strong></p>
<ul>
<li>一个主进程和多个工作进程。工作进程是单线程的，且不需要特殊授权即可运行；</li>
<li>kqueue (FreeBSD 4.1+), epoll (Linux 2.6+), rt signals (Linux 2.2.19+), /dev/poll (Solaris 7 11/99+), select, 以及 poll 支持；</li>
<li>kqueue支持的不同功能包括 EV_CLEAR, EV_DISABLE （临时禁止事件）， NOTE_LOWAT, EV_EOF, 有效数据的数目，错误代码；</li>
<li>sendfile (FreeBSD 3.1+), sendfile (Linux 2.2+), sendfile64 (Linux 2.4.21+), 和 sendfilev (Solaris 8 7/01+) 支持；</li>
<li>输入过滤 (FreeBSD 4.1+) 以及 TCP_DEFER_ACCEPT (Linux 2.4+) 支持；</li>
<li>10,000 非活动的 HTTP keep-alive 连接仅需要 2.5M 内存。</li>
<li>最小化的数据拷贝操作；</li>
</ul>
<p><strong><strong>其他HTTP功能：</strong></strong></p>
<ul>
<li>基于IP 和名称的虚拟主机服务；</li>
<li>Memcached 的 GET 接口；</li>
<li>支持 keep-alive 和管道连接；</li>
<li>灵活简单的配置；</li>
<li>重新配置和在线升级而无须中断客户的工作进程；</li>
<li>可定制的访问日志，日志写入缓存，以及快捷的日志回卷；</li>
<li>4xx-5xx 错误代码重定向；</li>
<li>基于 PCRE 的 rewrite 重写模块；</li>
<li>基于客户端 IP 地址和 HTTP 基本认证的访问控制；</li>
<li>PUT, DELETE, 和 MKCOL 方法；</li>
<li>支持 FLV （Flash 视频）；</li>
<li>带宽限制；</li>
</ul>
<p><strong><strong>实验特性：</strong></strong></p>
<ul>
<li>内嵌的<code>perl</code></li>
<li>通过<code>aio_read() / aio_write()</code>的套接字工作的实验模块，仅在 FreeBSD 下。</li>
<li>对线程的实验化支持，FreeBSD 4.x 的实现基于 rfork()</li>
</ul>
<p>Nginx 主要的英语站点是 <a target="_blank" rel="noopener" href="http://sysoev.ru/en/">http://sysoev.ru/en/</a></p>
<p>英语文档草稿由 Aleksandar Lazic 完成 <a target="_blank" rel="noopener" href="http://nginx.net/">点击</a> 。</p>
<h1 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nginx可以使用各平台的默认包来安装，本文是介绍使用源码编译安装，包括具体的编译参数信息。</span></span><br><span class="line"></span><br><span class="line"><span class="string">正式开始前，编译环境gcc</span> <span class="string">g++</span> <span class="string">开发库之类的需要提前装好，这里默认你已经装好。</span></span><br><span class="line"></span><br><span class="line"><span class="string">ububtu平台编译环境可以使用以下指令</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">build-essential</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">libtool</span></span><br><span class="line"><span class="string">centos平台编译环境使用如下指令</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装make：</span></span><br><span class="line"><span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">gcc</span> <span class="string">automake</span> <span class="string">autoconf</span> <span class="string">libtool</span> <span class="string">make</span></span><br><span class="line"><span class="string">安装g++:</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">gcc</span> <span class="string">gcc-c++</span></span><br><span class="line"><span class="string">下面正式开始</span></span><br><span class="line"><span class="string">---------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">一般我们都需要先装pcre,</span> <span class="string">zlib，前者为了重写rewrite，后者为了gzip压缩。</span></span><br><span class="line"><span class="number">1</span><span class="string">.选定源码目录</span></span><br><span class="line"><span class="string">可以是任何目录，本文选定的是/usr/local/src</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/src</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.安装PCRE库</span></span><br><span class="line"><span class="string">https://ftp.pcre.org/pub/pcre/</span> <span class="string">下载最新的</span> <span class="string">PCRE</span> <span class="string">源码包，使用下面命令下载编译和安装</span> <span class="string">PCRE</span> <span class="string">包：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/src</span></span><br><span class="line"><span class="string">wget</span> <span class="string">https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz</span> </span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">pcre-8.44.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">pcre-8.44</span></span><br><span class="line"><span class="string">./configure</span></span><br><span class="line"><span class="string">make</span></span><br><span class="line"><span class="string">make</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.安装zlib库</span></span><br><span class="line"><span class="string">http://zlib.net/zlib-1.2.11.tar.gz</span> <span class="string">下载最新的</span> <span class="string">zlib</span> <span class="string">源码包，使用下面命令下载编译和安装</span> <span class="string">zlib包：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/src</span></span><br><span class="line"><span class="string">wget</span> <span class="string">http://zlib.net/zlib-1.2.11.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">zlib-1.2.11.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">zlib-1.2.11</span></span><br><span class="line"><span class="string">./configure</span></span><br><span class="line"><span class="string">make</span></span><br><span class="line"><span class="string">make</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.安装ssl（某些vps默认没装ssl)</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/src</span></span><br><span class="line"><span class="string">wget</span> <span class="string">https://www.openssl.org/source/openssl-1.1.1g.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">openssl-1.1.1g.tar.gz</span></span><br><span class="line"><span class="number">5</span><span class="string">.安装nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">Nginx</span> <span class="string">一般有两个版本，分别是稳定版和开发版，您可以根据您的目的来选择这两个版本的其中一个，下面是把</span> <span class="string">Nginx</span> <span class="string">安装到</span> <span class="string">/usr/local/nginx</span> <span class="string">目录下的详细步骤：</span></span><br><span class="line"></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/src</span></span><br><span class="line"><span class="string">wget</span> <span class="string">http://nginx.org/download/nginx-1.18.0.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">nginx-1.18.0.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">nginx-1.18.0</span></span><br><span class="line"> </span><br><span class="line"><span class="string">./configure</span> <span class="string">--sbin-path=/usr/local/nginx/nginx</span> <span class="string">\</span></span><br><span class="line"><span class="string">--conf-path=/usr/local/nginx/nginx.conf</span> <span class="string">\</span></span><br><span class="line"><span class="string">--pid-path=/usr/local/nginx/nginx.pid</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-http_gzip_static_module</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-http_stub_status_module</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-file-aio</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-http_realip_module</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-http_ssl_module</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-pcre=/usr/local/src/pcre-8.44</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-zlib=/usr/local/src/zlib-1.2.11</span> <span class="string">\</span></span><br><span class="line"><span class="string">--with-openssl=/usr/local/src/openssl-1.1.1g</span></span><br><span class="line"> </span><br><span class="line"><span class="string">make</span> <span class="string">-j2</span></span><br><span class="line"><span class="string">make</span> <span class="string">install</span></span><br><span class="line"><span class="string">--with-pcre=/usr/local/src/pcre-8.44</span> <span class="string">指的是pcre-8.44</span> <span class="string">的源码路径。</span></span><br><span class="line"><span class="string">--with-zlib=/usr/local/src/zlib-1.2.11指的是zlib-1.2.11</span> <span class="string">的源码路径。</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装成功后</span> <span class="string">/usr/local/nginx</span> <span class="string">目录下如下</span></span><br><span class="line"><span class="string">fastcgi.conf</span>            <span class="string">koi-win</span>             <span class="string">nginx.conf.default</span></span><br><span class="line"><span class="string">fastcgi.conf.default</span>    <span class="string">logs</span>                <span class="string">scgi_params</span></span><br><span class="line"><span class="string">fastcgi_params</span>          <span class="string">mime.types</span>          <span class="string">scgi_params.default</span></span><br><span class="line"><span class="string">fastcgi_params.default</span>  <span class="string">mime.types.default</span>  <span class="string">uwsgi_params</span></span><br><span class="line"><span class="string">html</span>                    <span class="string">nginx</span>               <span class="string">uwsgi_params.default</span></span><br><span class="line"><span class="string">koi-utf</span>                 <span class="string">nginx.conf</span>          <span class="string">win-utf</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span><span class="string">.启动</span></span><br><span class="line"><span class="string">确保系统的</span> <span class="number">80</span> <span class="string">端口没被其他程序占用，运行/usr/local/nginx/nginx</span> <span class="string">命令来启动</span> <span class="string">Nginx，</span></span><br><span class="line"><span class="string">netstat</span> <span class="string">-ano|grep</span> <span class="number">80</span></span><br><span class="line"><span class="string">如果查不到结果后执行，有结果则忽略此步骤（ubuntu下必须用sudo启动，不然只能在前台运行）</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">/usr/local/nginx/nginx</span></span><br><span class="line"><span class="string">打开浏览器访问此机器的</span> <span class="string">IP，如果浏览器出现</span> <span class="string">Welcome</span> <span class="string">to</span> <span class="string">nginx!</span> <span class="string">则表示</span> <span class="string">Nginx</span> <span class="string">已经安装并运行成功。</span></span><br><span class="line"></span><br><span class="line"><span class="type">![nginx](nginx11.png)</span></span><br><span class="line"></span><br><span class="line"><span class="string">-----------------------------------------------------</span></span><br><span class="line"><span class="string">到这里nginx就安装完成了，如果只是处理静态html就不用继续安装了</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果你需要处理php脚本的话，还需要安装php-fpm。</span></span><br><span class="line"></span><br><span class="line"><span class="string">下面安装排错</span></span><br><span class="line"></span><br><span class="line"><span class="string">附：可能遇到的错误和一些帮助信息</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="string">编译pcre错误</span></span><br><span class="line"><span class="attr">libtool: compile:</span> <span class="string">unrecognized</span> <span class="string">option</span> <span class="string">`-DHAVE_CONFIG_H&#x27;</span></span><br><span class="line"><span class="attr">libtool: compile:</span> <span class="string">Try</span> <span class="string">`libtool</span> <span class="string">--help&#x27;</span> <span class="string">for</span> <span class="string">more</span> <span class="string">information.</span></span><br><span class="line"><span class="string">make[1]:</span> <span class="string">***</span> [<span class="string">pcrecpp.lo</span>] <span class="string">Error</span> <span class="number">1</span></span><br><span class="line"><span class="string">make[1]:</span> <span class="string">Leaving</span> <span class="string">directory</span> <span class="string">`/usr/local/src/pcre-8.34&#x27;</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">***</span> [<span class="string">all</span>] <span class="string">Error</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="type">![nginx](nginx22.png)</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法：安装g++,别忘了重新configure</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">g++</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">build-essential</span></span><br><span class="line"><span class="string">make</span> <span class="string">clean</span></span><br><span class="line"><span class="string">./configure</span></span><br><span class="line"><span class="string">make</span></span><br><span class="line"></span><br><span class="line"><span class="number">1.2</span> <span class="string">make出错</span></span><br><span class="line"><span class="attr">make:</span> <span class="string">***</span> <span class="literal">No</span> <span class="string">rule</span> <span class="string">to</span> <span class="string">make</span> <span class="string">target</span> <span class="string">`build&#x27;,</span> <span class="string">needed</span> <span class="string">by</span> <span class="string">`default&#x27;.</span>  <span class="string">Stop.</span></span><br><span class="line"><span class="string">./configure:</span> <span class="attr">error:</span> <span class="string">SSL</span> <span class="string">modules</span> <span class="string">require</span> <span class="string">the</span> <span class="string">OpenSSL</span> <span class="string">library.</span></span><br><span class="line"><span class="string">You</span> <span class="string">can</span> <span class="string">either</span> <span class="string">do</span> <span class="string">not</span> <span class="string">enable</span> <span class="string">the</span> <span class="string">modules,</span> <span class="string">or</span> <span class="string">install</span> <span class="string">the</span> <span class="string">OpenSSL</span> <span class="string">library</span></span><br><span class="line"><span class="string">into</span> <span class="string">the</span> <span class="string">system,</span> <span class="string">or</span> <span class="string">build</span> <span class="string">the</span> <span class="string">OpenSSL</span> <span class="string">library</span> <span class="string">statically</span> <span class="string">from</span> <span class="string">the</span> <span class="string">source</span></span><br><span class="line"><span class="string">with</span> <span class="string">nginx</span> <span class="string">by</span> <span class="string">using</span> <span class="string">--with-openssl=</span> <span class="string">option.</span></span><br><span class="line"><span class="string">按照第4步的安装方法或</span></span><br><span class="line"><span class="string">ubuntu下</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">openssl</span></span><br><span class="line"><span class="string">apt-get</span> <span class="string">install</span> <span class="string">libssl-dev</span></span><br><span class="line"><span class="string">centos下</span></span><br><span class="line"></span><br><span class="line"><span class="string">yum</span> <span class="string">-y</span> <span class="string">install</span> <span class="string">openssl</span> <span class="string">openssl-devel</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="string">nginx编译选项</span></span><br><span class="line"></span><br><span class="line"><span class="string">make是用来编译的，它从Makefile中读取指令，然后编译。</span></span><br><span class="line"></span><br><span class="line"><span class="string">make</span> <span class="string">install是用来安装的，它也从Makefile中读取指令，安装到指定的位置。</span></span><br><span class="line"></span><br><span class="line"><span class="string">configure命令是用来检测你的安装平台的目标特征的。它定义了系统的各个方面，包括nginx的被允许使用的连接处理的方法，比如它会检测你是不是有CC或GCC，并不是需要CC或GCC，它是个shell脚本，执行结束时，它会创建一个Makefile文件。nginx的configure命令支持以下参数：</span></span><br><span class="line"></span><br><span class="line"><span class="string">--prefix=path</span>    <span class="string">定义一个目录，存放服务器上的文件</span> <span class="string">，也就是nginx的安装目录。默认使用</span> <span class="string">/usr/local/nginx。</span></span><br><span class="line"><span class="string">--sbin-path=path</span> <span class="string">设置nginx的可执行文件的路径，默认为</span>  <span class="string">prefix/sbin/nginx.</span></span><br><span class="line"><span class="string">--conf-path=path</span>  <span class="string">设置在nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为prefix/conf/nginx.conf.</span></span><br><span class="line"><span class="string">--pid-path=path</span>  <span class="string">设置nginx.pid文件，将存储的主进程的进程号。安装完成后，可以随时改变的文件名</span> <span class="string">，</span> <span class="string">在nginx.conf配置文件中使用</span> <span class="string">PID指令。默认情况下，文件名</span> <span class="string">为prefix/logs/nginx.pid.</span></span><br><span class="line"><span class="string">--error-log-path=path</span> <span class="string">设置主错误，警告，和诊断文件的名称。安装完成后，可以随时改变的文件名</span> <span class="string">，在nginx.conf配置文件中</span> <span class="string">使用</span> <span class="string">的error_log指令。默认情况下，文件名</span> <span class="string">为prefix/logs/error.log.</span></span><br><span class="line"><span class="string">--http-log-path=path</span>  <span class="string">设置主请求的HTTP服务器的日志文件的名称。安装完成后，可以随时改变的文件名</span> <span class="string">，在nginx.conf配置文件中</span> <span class="string">使用</span> <span class="string">的access_log指令。默认情况下，文件名</span> <span class="string">为prefix/logs/access.log.</span></span><br><span class="line"><span class="string">--user=name</span>  <span class="string">设置nginx工作进程的用户。安装完成后，可以随时更改的名称在nginx.conf配置文件中</span> <span class="string">使用的</span> <span class="string">user指令。默认的用户名是nobody。</span></span><br><span class="line"><span class="string">--group=name</span>  <span class="string">设置nginx工作进程的用户组。安装完成后，可以随时更改的名称在nginx.conf配置文件中</span> <span class="string">使用的</span> <span class="string">user指令。默认的为非特权用户。</span></span><br><span class="line"><span class="string">--with-select_module</span> <span class="string">--without-select_module</span> <span class="string">启用或禁用构建一个模块来允许服务器使用select()方法。该模块将自动建立，如果平台不支持的kqueue，epoll，rtsig或/dev/poll。</span></span><br><span class="line"><span class="string">--with-poll_module</span> <span class="string">--without-poll_module</span> <span class="string">启用或禁用构建一个模块来允许服务器使用poll()方法。该模块将自动建立，如果平台不支持的kqueue，epoll，rtsig或/dev/poll。</span></span><br><span class="line"><span class="string">--without-http_gzip_module</span> <span class="string">—</span> <span class="string">不编译压缩的HTTP服务器的响应模块。编译并运行此模块需要zlib库。</span></span><br><span class="line"><span class="string">--without-http_rewrite_module</span>  <span class="string">不编译重写模块。编译并运行此模块需要PCRE库支持。</span></span><br><span class="line"><span class="string">--without-http_proxy_module</span> <span class="string">—</span> <span class="string">不编译http_proxy模块。</span></span><br><span class="line"><span class="string">--with-http_ssl_module</span> <span class="string">—</span> <span class="string">使用https协议模块。默认情况下，该模块没有被构建。建立并运行此模块的OpenSSL库是必需的。</span></span><br><span class="line"><span class="string">--with-pcre=path</span> <span class="string">—</span> <span class="string">设置PCRE库的源码路径。PCRE库的源码（版本4.4</span> <span class="bullet">-</span> <span class="number">8.30</span><span class="string">）需要从PCRE网站下载并解压。其余的工作是Nginx的./</span> <span class="string">configure和make来完成。正则表达式使用在location指令和</span> <span class="string">ngx_http_rewrite_module</span> <span class="string">模块中。</span></span><br><span class="line"><span class="string">--with-pcre-jit</span> <span class="string">—编译PCRE包含“just-in-time</span> <span class="string">compilation”（1.1.12中，</span> <span class="string">pcre_jit指令）。</span></span><br><span class="line"><span class="string">--with-zlib=path</span> <span class="string">—设置的zlib库的源码路径。要下载从</span> <span class="string">zlib（版本1.1.3</span> <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.5</span><span class="string">）的并解压。其余的工作是Nginx的./</span> <span class="string">configure和make完成。ngx_http_gzip_module模块需要使用zlib</span> <span class="string">。</span></span><br><span class="line"><span class="string">--with-cc-opt=parameters</span> <span class="string">—</span> <span class="string">设置额外的参数将被添加到CFLAGS变量。例如,当你在FreeBSD上使用PCRE库时需要使用:--with-cc-opt=&quot;-I</span> <span class="string">/usr/local/include。.如需要需要增加</span> <span class="string">select()支持的文件数量:--with-cc-opt=&quot;-D</span> <span class="string">FD_SETSIZE=2048&quot;.</span></span><br><span class="line"><span class="string">--with-ld-opt=parameters</span> <span class="string">—设置附加的参数，将用于在链接期间。例如，当在FreeBSD下使用该系统的PCRE库,应指定:--with-ld-opt=&quot;-L</span> <span class="string">/usr/local/lib&quot;.</span></span><br><span class="line"><span class="string">典型实例(下面为了展示需要写在多行，执行时内容需要在同一行)</span></span><br><span class="line"></span><br><span class="line"><span class="string">./configure</span></span><br><span class="line">    <span class="string">--sbin-path=/usr/local/nginx/nginx</span></span><br><span class="line">    <span class="string">--conf-path=/usr/local/nginx/nginx.conf</span></span><br><span class="line">    <span class="string">--pid-path=/usr/local/nginx/nginx.pid</span></span><br><span class="line">    <span class="string">--with-http_ssl_module</span></span><br><span class="line">    <span class="string">--with-pcre=../pcre-4.4</span></span><br><span class="line">    <span class="string">--with-zlib=../zlib-1.1.3</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="nginx基本配置与参数说明"><a href="#nginx基本配置与参数说明" class="headerlink" title="nginx基本配置与参数说明"></a>nginx基本配置与参数说明</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行用户</span></span><br><span class="line"><span class="string">user</span> <span class="string">nobody;</span></span><br><span class="line"><span class="comment">#启动进程,通常设置成和cpu的数量相等</span></span><br><span class="line"><span class="string">worker_processes</span>  <span class="number">1</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全局错误日志及PID文件</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#工作模式及连接数上限</span></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="comment">#epoll是多路复用IO(I/O Multiplexing)中的一种方式,</span></span><br><span class="line">    <span class="comment">#仅用于linux2.6以上内核,可以大大提高nginx的性能</span></span><br><span class="line">    <span class="string">use</span>   <span class="string">epoll;</span> </span><br><span class="line"></span><br><span class="line">    <span class="comment">#单个后台worker process进程的最大并发链接数    </span></span><br><span class="line">    <span class="string">worker_connections</span>  <span class="number">1024</span><span class="string">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并发总数是 worker_processes 和 worker_connections 的乘积</span></span><br><span class="line">    <span class="comment"># 即 max_clients = worker_processes * worker_connections</span></span><br><span class="line">    <span class="comment"># 在设置了反向代理的情况下，max_clients = worker_processes * worker_connections / 4  为什么</span></span><br><span class="line">    <span class="comment"># 为什么上面反向代理要除以4，应该说是一个经验值</span></span><br><span class="line">    <span class="comment"># 根据以上条件，正常情况下的Nginx Server可以应付的最大连接数为：4 * 8000 = 32000</span></span><br><span class="line">    <span class="comment"># worker_connections 值的设置跟物理内存大小有关</span></span><br><span class="line">    <span class="comment"># 因为并发受IO约束，max_clients的值须小于系统可以打开的最大文件数</span></span><br><span class="line">    <span class="comment"># 而系统可以打开的最大文件数和内存大小成正比，一般1GB内存的机器上可以打开的文件数大约是10万左右</span></span><br><span class="line">    <span class="comment"># 我们来看看360M内存的VPS可以打开的文件句柄数是多少：</span></span><br><span class="line">    <span class="comment"># $ cat /proc/sys/fs/file-max</span></span><br><span class="line">    <span class="comment"># 输出 34336</span></span><br><span class="line">    <span class="comment"># 32000 &lt; 34336，即并发连接总数小于系统可以打开的文件句柄总数，这样就在操作系统可以承受的范围之内</span></span><br><span class="line">    <span class="comment"># 所以，worker_connections 的值需根据 worker_processes 进程数目和系统可以打开的最大文件总数进行适当地进行设置</span></span><br><span class="line">    <span class="comment"># 使得并发总数小于操作系统可以打开的最大文件数目</span></span><br><span class="line">    <span class="comment"># 其实质也就是根据主机的物理CPU和内存进行配置</span></span><br><span class="line">    <span class="comment"># 当然，理论上的并发总数可能会和实际有所偏差，因为主机还有其他的工作进程需要消耗系统资源。</span></span><br><span class="line">    <span class="comment"># ulimit -SHn 65535</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    <span class="string">include</span>    <span class="string">mime.types;</span></span><br><span class="line">    <span class="string">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    <span class="string">log_format</span>  <span class="string">main</span>  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">access_log</span>  <span class="string">logs/access.log</span>  <span class="string">main;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，</span></span><br><span class="line">    <span class="comment">#对于普通应用，必须设为 on,</span></span><br><span class="line">    <span class="comment">#如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，</span></span><br><span class="line">    <span class="comment">#以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><br><span class="line">    <span class="string">sendfile</span>     <span class="string">on;</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#连接超时时间</span></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="string">keepalive_timeout</span>  <span class="number">65</span><span class="string">;</span></span><br><span class="line">    <span class="string">tcp_nodelay</span>     <span class="string">on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#开启gzip压缩</span></span><br><span class="line">    <span class="string">gzip</span>  <span class="string">on;</span></span><br><span class="line">    <span class="string">gzip_disable</span> <span class="string">&quot;MSIE [1-6].&quot;</span><span class="string">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#设定请求缓冲</span></span><br><span class="line">    <span class="string">client_header_buffer_size</span>    <span class="string">128k;</span></span><br><span class="line">    <span class="string">large_client_header_buffers</span>  <span class="number">4</span> <span class="string">128k;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定虚拟主机配置</span></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="comment">#侦听80端口</span></span><br><span class="line">        <span class="string">listen</span>    <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="comment">#定义使用 www.nginx.cn访问</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">www.nginx.cn;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">        <span class="string">root</span> <span class="string">html;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">#设定本虚拟主机的访问日志</span></span><br><span class="line">        <span class="string">access_log</span>  <span class="string">logs/nginx.access.log</span>  <span class="string">main;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">#默认请求</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">            <span class="string">index</span> <span class="string">index.php</span> <span class="string">index.html</span> <span class="string">index.htm;</span>   </span><br><span class="line">    </span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 定义错误提示页面</span></span><br><span class="line">        <span class="string">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="string">/50x.html;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">=</span> <span class="string">/50x.html</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#静态文件，nginx自己处理</span></span><br><span class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">^/(images|javascript|js|css|flash|media|static)/</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#过期30天，静态文件不怎么更新，过期可以设大一点，</span></span><br><span class="line">            <span class="comment">#如果频繁更新，则可以设置得小一点。</span></span><br><span class="line">            <span class="string">expires</span> <span class="string">30d;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI默认配置.</span></span><br><span class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.php$</span> &#123;</span><br><span class="line">            <span class="string">fastcgi_pass</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000;</span></span><br><span class="line">            <span class="string">fastcgi_index</span> <span class="string">index.php;</span></span><br><span class="line">            <span class="string">fastcgi_param</span>  <span class="string">SCRIPT_FILENAME</span>  <span class="string">$document_root$fastcgi_script_name;</span></span><br><span class="line">            <span class="string">include</span> <span class="string">fastcgi_params;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">#禁止访问 .htxxx 文件</span></span><br><span class="line">            <span class="string">location</span> <span class="string">~</span> <span class="string">/.ht</span> &#123;</span><br><span class="line">            <span class="string">deny</span> <span class="string">all;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="运行和控制nginx"><a href="#运行和控制nginx" class="headerlink" title="运行和控制nginx"></a>运行和控制nginx</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nginx命令行参数</span></span><br><span class="line"><span class="string">不像许多其他软件系统，Nginx</span> <span class="string">仅有几个命令行参数，完全通过配置文件来配置</span></span><br><span class="line"></span><br><span class="line"><span class="string">-c</span> <span class="string">&lt;/path/to/config&gt;</span> <span class="string">为</span> <span class="string">Nginx</span> <span class="string">指定一个配置文件，来代替缺省的。</span></span><br><span class="line"></span><br><span class="line"><span class="string">-t</span> <span class="string">不运行，而仅仅测试配置文件。nginx</span> <span class="string">将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">-v</span> <span class="string">显示</span> <span class="string">nginx</span> <span class="string">的版本。</span></span><br><span class="line"></span><br><span class="line"><span class="string">-V</span> <span class="string">显示</span> <span class="string">nginx</span> <span class="string">的版本，编译器版本和配置参数。</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">nginx控制信号</span></span><br><span class="line"><span class="string">可以使用信号系统来控制主进程。默认，nginx</span> <span class="string">将其主进程的</span> <span class="string">pid</span> <span class="string">写入到</span> <span class="string">/usr/local/nginx/nginx.pid</span> <span class="string">文件中。通过传递参数给</span> <span class="string">./configure</span> <span class="string">或使用</span> <span class="string">pid</span> <span class="string">指令，来改变该文件的位置。</span></span><br><span class="line"></span><br><span class="line"><span class="string">主进程可以处理以下的信号：</span></span><br><span class="line"></span><br><span class="line"><span class="string">TERM,</span> <span class="string">INT</span>	<span class="string">快速关闭</span></span><br><span class="line"><span class="string">QUIT</span>	<span class="string">从容关闭</span></span><br><span class="line"><span class="string">HUP</span>	<span class="string">重载配置</span></span><br><span class="line"><span class="string">用新的配置开始新的工作进程</span></span><br><span class="line"><span class="string">从容关闭旧的工作进程</span></span><br><span class="line"><span class="string">USR1</span>	<span class="string">重新打开日志文件</span></span><br><span class="line"><span class="string">USR2</span>	<span class="string">平滑升级可执行程序。</span></span><br><span class="line"><span class="string">WINCH</span>	<span class="string">从容关闭工作进程</span></span><br><span class="line"><span class="string">尽管你不必自己操作工作进程，但是，它们也支持一些信号：</span></span><br><span class="line"></span><br><span class="line"><span class="string">TERM,</span> <span class="string">INT</span>	<span class="string">快速关闭</span></span><br><span class="line"><span class="string">QUIT</span>	<span class="string">从容关闭</span></span><br><span class="line"><span class="string">USR1</span>	<span class="string">重新打开日志文件</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">nginx</span> <span class="string">启动、停止、重启命令</span></span><br><span class="line"><span class="string">nginx启动</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">/usr/local/nginx/nginx</span>     <span class="string">(nginx二进制文件绝对路径，可以根据自己安装路径实际决定)</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">nginx从容停止命令，等所有请求结束后关闭服务</span></span><br><span class="line"></span><br><span class="line"><span class="string">ps</span> <span class="string">-ef</span> <span class="string">|grep</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">kill</span> <span class="string">-QUIT</span>  <span class="string">nginx主进程号</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">nginx</span> <span class="string">快速停止命令，立刻关闭nginx进程</span></span><br><span class="line"></span><br><span class="line"><span class="string">ps</span> <span class="string">-ef</span> <span class="string">|grep</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">kill</span> <span class="string">-TERM</span> <span class="string">nginx主进程号</span> </span><br><span class="line"></span><br><span class="line"><span class="string">如果以上命令不管用，可以强制停止</span></span><br><span class="line"></span><br><span class="line"><span class="string">kill</span> <span class="number">-9</span> <span class="string">nginx主进程号</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">如果嫌麻烦可以不用查看进程号，直接使用命令进行操作</span></span><br><span class="line"><span class="string">其中/usr/local/nginx/nginx.pid</span> <span class="string">为nginx.conf中pid命令设置的参数，用来存放nginx主进程号的文件</span></span><br><span class="line"><span class="string">kill</span> <span class="string">-信号类型(HUP|TERM|QUIT)</span> <span class="string">cat</span> <span class="string">/usr/local/nginx/nginx.pid</span></span><br><span class="line"><span class="string">例如</span></span><br><span class="line"></span><br><span class="line"><span class="string">kill</span> <span class="string">-QUIT</span> <span class="string">`cat</span> <span class="string">/usr/local/nginx/nginx.pid`</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="string">kill</span> <span class="string">-QUIT</span> <span class="string">`cat</span> <span class="string">/usr/local/nginx/nginx.pid`</span></span><br><span class="line"><span class="string">nginx重启命令</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx重启可以分成几种类型</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.简单型，先关闭进程，修改你的配置后，重启进程。</span></span><br><span class="line"><span class="string">kill</span> <span class="string">-QUIT</span> <span class="string">cat</span> <span class="string">/usr/local/nginx/nginx.pid</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">/usr/local/nginx/nginx</span></span><br><span class="line"><span class="number">2</span><span class="string">.重新加载配置文件，不重启进程，不会停止处理请求</span></span><br><span class="line"><span class="number">3</span><span class="string">.平滑更新nginx二进制，不会停止处理请求</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">使用信号加载新的配置</span></span><br><span class="line"><span class="string">Nginx</span> <span class="string">支持几个信号，能在它运行时控制其操作。其中最普通的是</span> <span class="number">15</span> <span class="string">，用来中止运行的进程：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;strong&gt;ps aux | egrep &#x27;(PID|nginx)&#x27;&lt;/strong&gt;</span></span><br><span class="line"><span class="string">USER</span>       <span class="string">PID</span> <span class="string">%CPU</span> <span class="string">%MEM</span>    <span class="string">VSZ</span>   <span class="string">RSS</span> <span class="string">TTY</span>      <span class="string">STAT</span> <span class="string">START</span>   <span class="string">TIME</span> <span class="string">COMMAND</span></span><br><span class="line"><span class="string">root</span>      <span class="number">2213  </span><span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">6784  </span><span class="number">2036</span> <span class="string">?</span>        <span class="attr">Ss   03:01   0:00 nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-c</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># &lt;strong&gt;kill -15 2213&lt;/strong&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;strong&gt;ps aux | egrep &#x27;(PID|nginx)&#x27;&lt;/strong&gt;</span></span><br><span class="line"><span class="string">USER</span>       <span class="string">PID</span> <span class="string">%CPU</span> <span class="string">%MEM</span>    <span class="string">VSZ</span>   <span class="string">RSS</span> <span class="string">TTY</span>      <span class="string">STAT</span> <span class="string">START</span>   <span class="string">TIME</span> <span class="string">COMMAND</span></span><br><span class="line"><span class="string">root</span>      <span class="number">2213  </span><span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">6784  </span><span class="number">2036</span> <span class="string">?</span>        <span class="attr">Ss   03:01   0:00 nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-c</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># &lt;strong&gt;kill -15 2213&lt;/strong&gt;</span></span><br><span class="line"><span class="string">而最有趣的是能平滑改变</span> <span class="string">nginx</span> <span class="string">配置的选项（请注意，在重载前，要先测试一下配置文件）：</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;strong&gt; nginx -t -c /etc/nginx/nginx.conf&lt;/strong&gt;</span></span><br><span class="line"><span class="number">2006</span><span class="string">/09/16</span> <span class="number">13</span><span class="string">:07:10</span> [<span class="string">info</span>] <span class="number">15686</span><span class="comment">#0: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span><br><span class="line"><span class="number">2006</span><span class="string">/09/16</span> <span class="number">13</span><span class="string">:07:10</span> [<span class="string">info</span>] <span class="number">15686</span><span class="comment">#0: the configuration file /etc/nginx/nginx.conf was tested successfully</span></span><br><span class="line"><span class="comment">#&lt;strong&gt; ps aux | egrep &#x27;(PID|nginx)&#x27;&lt;/strong&gt;</span></span><br><span class="line"><span class="string">USER</span>       <span class="string">PID</span> <span class="string">%CPU</span> <span class="string">%MEM</span>    <span class="string">VSZ</span>   <span class="string">RSS</span> <span class="string">TTY</span>      <span class="string">STAT</span> <span class="string">START</span>   <span class="string">TIME</span> <span class="string">COMMAND</span></span><br><span class="line"><span class="string">root</span>      <span class="number">2213  </span><span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">6784  </span><span class="number">2036</span> <span class="string">?</span>        <span class="attr">Ss   03:01   0:00 nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-c</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="string">&lt;strong&gt;#</span> <span class="string">kill</span> <span class="string">-HUP</span> <span class="number">2213</span><span class="string">&lt;/strong&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;strong&gt; nginx -t -c /etc/nginx/nginx.conf&lt;/strong&gt;</span></span><br><span class="line"><span class="number">2006</span><span class="string">/09/16</span> <span class="number">13</span><span class="string">:07:10</span> [<span class="string">info</span>] <span class="number">15686</span><span class="comment">#0: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span><br><span class="line"><span class="number">2006</span><span class="string">/09/16</span> <span class="number">13</span><span class="string">:07:10</span> [<span class="string">info</span>] <span class="number">15686</span><span class="comment">#0: the configuration file /etc/nginx/nginx.conf was tested successfully</span></span><br><span class="line"><span class="comment">#&lt;strong&gt; ps aux | egrep &#x27;(PID|nginx)&#x27;&lt;/strong&gt;</span></span><br><span class="line"><span class="string">USER</span>       <span class="string">PID</span> <span class="string">%CPU</span> <span class="string">%MEM</span>    <span class="string">VSZ</span>   <span class="string">RSS</span> <span class="string">TTY</span>      <span class="string">STAT</span> <span class="string">START</span>   <span class="string">TIME</span> <span class="string">COMMAND</span></span><br><span class="line"><span class="string">root</span>      <span class="number">2213  </span><span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">6784  </span><span class="number">2036</span> <span class="string">?</span>        <span class="attr">Ss   03:01   0:00 nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-c</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="string">&lt;strong&gt;#</span> <span class="string">kill</span> <span class="string">-HUP</span> <span class="number">2213</span><span class="string">&lt;/strong&gt;</span></span><br><span class="line"><span class="string">当</span> <span class="string">nginx</span> <span class="string">接收到</span> <span class="string">HUP</span> <span class="string">信号，它会尝试先解析配置文件（如果指定配置文件，就使用指定的，否则使用默认的），成功的话，就应用新的配置文件（例如：重新打开日志文件或监听的套接</span> <span class="string">字）。之后，nginx</span> <span class="string">运行新的工作进程并从容关闭旧的工作进程。通知工作进程关闭监听套接字但是继续为当前连接的客户提供服务。所有客户端的服务完成后，旧的工作进程被关闭。</span> <span class="string">如果新的配置文件应用失败，nginx</span> <span class="string">将继续使用旧的配置进行工作。</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">平滑升级到新的二进制代码</span></span><br><span class="line"><span class="string">你可以在不中断服务的情况下</span> <span class="bullet">-</span> <span class="string">新的请求也不会丢失，使用新的</span> <span class="string">nginx</span> <span class="string">可执行程序替换旧的（当升级新版本或添加/删除服务器模块时）。</span></span><br><span class="line"></span><br><span class="line"><span class="string">首先，使用新的可执行程序替换旧的（最好做好备份），然后，发送</span> <span class="string">USR2</span> <span class="string">(kill</span> <span class="string">-USR2</span> <span class="string">pid)信号给主进程。主进程将重命名它的</span> <span class="string">.pid</span> <span class="string">文件为</span> <span class="string">.oldbin</span> <span class="string">(比如：/usr/local/nginx/logs/nginx.pid.oldbin)，然后执行新的可执行程序，依次启动新的主进程和新的工作进程：</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">33134 33126 nobody   0.0  1368 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">33135 33126 nobody   0.0  1380 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">33136 33126 nobody   0.0  1368 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">33134 33126 nobody   0.0  1368 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">33135 33126 nobody   0.0  1380 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">33136 33126 nobody   0.0  1368 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="string">在这时，两个</span> <span class="string">nginx</span> <span class="string">实例会同时运行，一起处理输入的请求。要逐步停止旧的实例，你必须发送</span> <span class="string">WINCH</span> <span class="string">信号给旧的主进程，然后，它的工作进程就将开始从容关闭：</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">33135 33126 nobody   0.0  1380 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">is</span> <span class="string">shutting</span> <span class="string">down</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">33135 33126 nobody   0.0  1380 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">is</span> <span class="string">shutting</span> <span class="string">down</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="string">一段时间后，旧的工作进程处理了所有已连接的请求后退出，就仅由新的工作进程来处理输入的请求了：</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"></span><br><span class="line">  <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line"><span class="attr">33126     1 root     0.0  1164 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36264 33126 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"><span class="string">这时，因为旧的服务器还尚未关闭它监听的套接字，所以，通过下面的几步，你仍可以恢复旧的服务器：</span></span><br><span class="line"></span><br><span class="line"><span class="string">发送</span> <span class="string">HUP</span> <span class="string">信号给旧的主进程</span> <span class="bullet">-</span> <span class="string">它将在不重载配置文件的情况下启动它的工作进程</span></span><br><span class="line"><span class="string">发送</span> <span class="string">QUIT</span> <span class="string">信号给新的主进程，要求其从容关闭其工作进程</span></span><br><span class="line"><span class="string">发送</span> <span class="string">TERM</span> <span class="string">信号给新的主进程，迫使其退出</span></span><br><span class="line"><span class="string">如果因为某些原因新的工作进程不能退出，向其发送</span> <span class="string">KILL</span> <span class="string">信号</span></span><br><span class="line"><span class="string">新的主进程退出后，旧的主进程会由移除</span> <span class="string">.oldbin</span> <span class="string">前缀，恢复为它的</span> <span class="string">.pid</span> <span class="string">文件，这样，一切就都恢复到升级之前了。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果尝试升级成功，而你也希望保留新的服务器时，发送</span> <span class="string">QUIT</span> <span class="string">信号给旧的主进程使其退出而只留下新的服务器运行：</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">      <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line">    <span class="attr">36264     1 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line">    <span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line">    <span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line">    <span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line"></span><br><span class="line">      <span class="string">PID</span>  <span class="string">PPID</span> <span class="string">USER</span>    <span class="string">%CPU</span>   <span class="string">VSZ</span> <span class="string">WCHAN</span>  <span class="string">COMMAND</span></span><br><span class="line">    <span class="attr">36264     1 root     0.0  1148 pause  nginx:</span> <span class="string">master</span> <span class="string">process</span> <span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line">    <span class="attr">36265 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line">    <span class="attr">36266 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br><span class="line">    <span class="attr">36267 36264 nobody   0.0  1364 kqread nginx:</span> <span class="string">worker</span> <span class="string">process</span> <span class="string">(nginx)</span></span><br></pre></td></tr></table></figure>

<h1 id="nginx反向代理配置"><a href="#nginx反向代理配置" class="headerlink" title="nginx反向代理配置"></a>nginx反向代理配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nginx作为web服务器一个重要的功能就是反向代理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">当然你也可以使用nginx配置正向代理，本是介绍如何配置nginx的反向代理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx反向代理的指令不需要新增额外的模块，默认自带proxy_pass指令，只需要修改配置文件就可以实现反向代理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">什么是反向代理服务器</span></span><br><span class="line"><span class="string">反向代理功能是nginx的三大主要功能之一（静态web服务器、反向代理、负载均衡）。nginx一般同时做为静态web服务器和反向代理服务器，做为web服务器访问静态文件图片、css、js、html等文件，做为反向代理服务器把请求发给后端业务处理服务，如果有多个后端处理节点，会配置负载均衡功能。</span></span><br><span class="line"></span><br><span class="line"><span class="string">反向代理服务器是一种代理服务器，用于管理从外部网络到内部网络的连接或任何特定请求。它保护、路由和管理从外部网络到内部网络、Web服务器或专用网络的流量。</span></span><br><span class="line"><span class="type">![nginx](nginx33.png)</span></span><br><span class="line"></span><br><span class="line"><span class="string">外网客户机：我们平时打开浏览器输入网址访问www.nginx.cn的场景中，我们的笔记本就可以理解为一个外网客户机。</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx反向代理服务：浏览器输入网址并回车后，会发起一个http请求给nginx（反向代理服务器），这个请求如果是访问静态文件，那么nginx作为web服务器直接返回请求的内容，如果是访问的后台服务逻辑，那么nginx把请求转发给后端的服务处理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">内网web服务：后端的服务可以是很多种类型，LNMP环境下的php-fpm进程，Java环境下的tomcat、jetty等容器，通过程序逻辑处理http请求，生成html页面或者json串返回给客户端。对于小型应用，后端服务可以和nginx部署在同一台机器上。</span></span><br><span class="line"></span><br><span class="line"><span class="string">反向代理服务器的好处</span></span><br><span class="line"><span class="string">nginx反向代理重要的作用是配合upstream实现负载均衡。</span></span><br><span class="line"></span><br><span class="line"><span class="string">同时增加安全性，客户端不能直接访问后端服务，多了一个中间的屏障。</span></span><br><span class="line"></span><br><span class="line"><span class="string">提升性能，通过异步非阻塞的方式把请求传给后端，提升了并发处理能力。</span></span><br><span class="line"></span><br><span class="line"><span class="string">也可利用缓存、压缩响应提高响应速度。</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx如何配置反向代理</span></span><br><span class="line"><span class="string">nginx反向代理不需要编译额外的模块，默认自带proxy_pass和fastcgi_pass指令，通过在location配置块中增加指令就可以实现反向代理功能。</span></span><br><span class="line"></span><br><span class="line"><span class="string">以www.nginx.cn为例，这个网站用的wordpress程序，wordpress是php语言编写，那么需要通过php运行环境，可以选择apache的php扩展或者php-fpm环境，主流的选择是php-fpm，php-fpm设置为Unix</span> <span class="string">socket模式或者ip:端口模式</span> <span class="string">。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Unix</span> <span class="string">socket后端服务配置</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">    <span class="string">server_name</span> <span class="string">www.nginx.cn</span> <span class="string">nginx.cn;</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">location</span> <span class="string">/app</span> &#123;</span><br><span class="line">       <span class="string">fastcgi_pass</span>  <span class="string">unix:/tmp/php-cgi.sock;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">ip端口后端服务配置</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">    <span class="string">server_name</span> <span class="string">www.nginx.cn</span> <span class="string">nginx.cn;</span></span><br><span class="line"> </span><br><span class="line">    <span class="string">location</span> <span class="string">/app</span> &#123;</span><br><span class="line">       <span class="string">proxy_pass</span> <span class="string">http://127.0.0.1:8080;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">proxy_pass和fastcgi_pass区别</span></span><br><span class="line"><span class="string">对于上面介绍的两种情况下proxy_pass和fastcgi_pass可以互相替代使用，不过两者还是有区别的，从名字我们就可以看出来，fastcgi_pass是用来反向代理fastcgi协议，proxy_pass可以代理包括fastcgi协议在内的其它协议。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例如镜像一个网站，这种情况下就需要proxy_pass：</span></span><br><span class="line"><span class="string">location</span> <span class="string">/&#123;</span></span><br><span class="line">    <span class="string">proxy_pass</span> <span class="string">http://www.baidu.com;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx-location匹配规则"><a href="#nginx-location匹配规则" class="headerlink" title="nginx location匹配规则"></a>nginx location匹配规则</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">location匹配命令</span></span><br><span class="line"></span><br><span class="line"><span class="string">~</span>      <span class="comment">#波浪线表示执行一个正则匹配，区分大小写</span></span><br><span class="line"><span class="string">~*</span>    <span class="comment">#表示执行一个正则匹配，不区分大小写</span></span><br><span class="line"><span class="string">^~</span>    <span class="comment">#^~表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录</span></span><br><span class="line"><span class="string">=</span>      <span class="comment">#进行普通字符精确匹配</span></span><br><span class="line"><span class="string">@</span>     <span class="comment">#&quot;@&quot; 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">location</span> <span class="string">匹配的优先级(与location在配置文件中的顺序无关)</span></span><br><span class="line"><span class="string">=</span> <span class="string">精确匹配会第一个被处理。如果发现精确匹配，nginx停止搜索其他匹配。</span></span><br><span class="line"><span class="string">普通字符匹配，正则表达式规则和长的块规则将被优先和查询匹配，也就是说如果该项匹配还需去看有没有正则表达式匹配和更长的匹配。</span></span><br><span class="line"><span class="string">^~</span> <span class="string">则只匹配该规则，nginx停止搜索其他匹配，否则nginx会继续处理其他location指令。</span></span><br><span class="line"><span class="string">最后匹配理带有&quot;~&quot;和&quot;~*&quot;的指令，如果找到相应的匹配，则nginx停止搜索其他匹配；当没有正则表达式或者没有正则表达式被匹配的情况下，那么匹配程度最高的逐字匹配指令会被使用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">location</span> <span class="string">优先级官方文档</span></span><br><span class="line"></span><br><span class="line"><span class="string">Directives</span> <span class="string">with</span> <span class="string">the</span> <span class="string">=</span> <span class="string">prefix</span> <span class="string">that</span> <span class="string">match</span> <span class="string">the</span> <span class="string">query</span> <span class="string">exactly.</span> <span class="string">If</span> <span class="string">found,</span> <span class="string">searching</span> <span class="string">stops.</span></span><br><span class="line"><span class="string">All</span> <span class="string">remaining</span> <span class="string">directives</span> <span class="string">with</span> <span class="string">conventional</span> <span class="string">strings,</span> <span class="string">longest</span> <span class="string">match</span> <span class="string">first.</span> <span class="string">If</span> <span class="string">this</span> <span class="string">match</span> <span class="string">used</span> <span class="string">the</span> <span class="string">^~</span> <span class="string">prefix,</span> <span class="string">searching</span> <span class="string">stops.</span></span><br><span class="line"><span class="string">Regular</span> <span class="string">expressions,</span> <span class="string">in</span> <span class="string">order</span> <span class="string">of</span> <span class="string">definition</span> <span class="string">in</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">file.</span></span><br><span class="line"><span class="string">If</span> <span class="comment">#3 yielded a match, that result is used. Else the match from #2 is used.</span></span><br><span class="line"><span class="string">=前缀的指令严格匹配这个查询。如果找到，停止搜索。</span></span><br><span class="line"><span class="string">所有剩下的常规字符串，最长的匹配。如果这个匹配使用^〜前缀，搜索停止。</span></span><br><span class="line"><span class="string">正则表达式，在配置文件中定义的顺序。</span></span><br><span class="line"><span class="string">如果第3条规则产生匹配的话，结果被使用。否则，使用第2条规则的结果。</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">例如</span></span><br><span class="line"><span class="string">location</span>  <span class="string">=</span> <span class="string">/</span> &#123;</span><br><span class="line">  <span class="comment"># 只匹配&quot;/&quot;.</span></span><br><span class="line">  [ <span class="string">configuration</span> <span class="string">A</span> ] </span><br><span class="line">&#125;</span><br><span class="line"><span class="string">location</span>  <span class="string">/</span> &#123;</span><br><span class="line">  <span class="comment"># 匹配任何请求，因为所有请求都是以&quot;/&quot;开始</span></span><br><span class="line">  <span class="comment"># 但是更长字符匹配或者正则表达式匹配会优先匹配</span></span><br><span class="line">  [ <span class="string">configuration</span> <span class="string">B</span> ] </span><br><span class="line">&#125;</span><br><span class="line"><span class="string">location</span> <span class="string">^~</span> <span class="string">/images/</span> &#123;</span><br><span class="line">  <span class="comment"># 匹配任何以 /images/ 开始的请求，并停止匹配 其它location</span></span><br><span class="line">  [ <span class="string">configuration</span> <span class="string">C</span> ] </span><br><span class="line">&#125;</span><br><span class="line"><span class="string">location</span> <span class="string">~*</span> <span class="string">.(gif|jpg|jpeg)$</span> &#123;</span><br><span class="line">  <span class="comment"># 匹配以 gif, jpg, or jpeg结尾的请求. </span></span><br><span class="line">  <span class="comment"># 但是所有 /images/ 目录的请求将由 [Configuration C]处理.   </span></span><br><span class="line">  [ <span class="string">configuration</span> <span class="string">D</span> ] </span><br><span class="line">&#125;</span><br><span class="line"><span class="string">请求URI例子:</span></span><br><span class="line"></span><br><span class="line"><span class="string">/</span> <span class="string">-&gt;</span> <span class="string">符合configuration</span> <span class="string">A</span></span><br><span class="line"><span class="string">/documents/document.html</span> <span class="string">-&gt;</span> <span class="string">符合configuration</span> <span class="string">B</span></span><br><span class="line"><span class="string">/images/1.gif</span> <span class="string">-&gt;</span> <span class="string">符合configuration</span> <span class="string">C</span></span><br><span class="line"><span class="string">/documents/1.jpg</span> <span class="string">-&gt;符合</span> <span class="string">configuration</span> <span class="string">D</span></span><br><span class="line"><span class="string">@location</span> <span class="string">例子</span></span><br><span class="line"><span class="string">error_page</span> <span class="number">404</span> <span class="string">=</span> <span class="string">@fetch;</span></span><br><span class="line"></span><br><span class="line"><span class="string">location</span> <span class="string">@fetch(</span></span><br><span class="line"><span class="string">proxy_pass</span> <span class="string">http://fetch;</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx-upstream-配置和作用"><a href="#nginx-upstream-配置和作用" class="headerlink" title="nginx upstream 配置和作用"></a>nginx upstream 配置和作用</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">配置例子</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="string">backend1.example.com</span>       <span class="string">weight=5;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">backend2.example.com:8080;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">unix:/tmp/backend3;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> <span class="string">backup1.example.com:8080</span>   <span class="string">backup;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">backup2.example.com:8080</span>   <span class="string">backup;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">        <span class="string">proxy_pass</span> <span class="string">http://backend;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">指令</span></span><br><span class="line"><span class="string">语法:</span>	<span class="string">upstream</span> <span class="string">name</span> &#123; <span class="string">...</span> &#125;</span><br><span class="line"><span class="string">默认值:</span>	<span class="string">—</span></span><br><span class="line"><span class="string">上下文:</span>	<span class="string">http</span></span><br><span class="line"><span class="string">定义一组服务器。</span> <span class="string">这些服务器可以监听不同的端口。</span> <span class="string">而且，监听在TCP和UNIX域套接字的服务器可以混用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例子：</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="string">backend1.example.com</span> <span class="string">weight=5;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span>       <span class="string">max_fails=3</span> <span class="string">fail_timeout=30s;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">unix:/tmp/backend3;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">默认情况下，nginx按加权轮转的方式将请求分发到各服务器。</span> <span class="string">在上面的例子中，每7个请求会通过以下方式分发：</span> <span class="number">5</span><span class="string">个请求分到backend1.example.com，</span> <span class="string">一个请求分到第二个服务器，一个请求分到第三个服务器。</span> <span class="string">与服务器通信的时候，如果出现错误，请求会被传给下一个服务器，直到所有可用的服务器都被尝试过。</span> <span class="string">如果所有服务器都返回失败，客户端将会得到最后通信的那个服务器的（失败）响应结果。</span></span><br><span class="line"></span><br><span class="line"><span class="string">语法:</span>	<span class="string">server</span> <span class="string">address</span> [<span class="string">parameters</span>]<span class="string">;</span></span><br><span class="line"><span class="string">默认值:</span>	<span class="string">—</span></span><br><span class="line"><span class="string">上下文:</span>	<span class="string">upstream</span></span><br><span class="line"><span class="string">定义服务器的地址address和其他参数parameters。</span> <span class="string">地址可以是域名或者IP地址，端口是可选的，或者是指定“unix:”前缀的UNIX域套接字的路径。如果没有指定端口，就使用80端口。</span> <span class="string">如果一个域名解析到多个IP，本质上是定义了多个server。</span></span><br><span class="line"></span><br><span class="line"><span class="string">你可以定义下面的参数：weight=number设定服务器的权重，默认是1。max_fails=number设定Nginx与服务器通信的尝试失败的次数。在fail_timeout参数定义的时间段内，如果失败的次数达到此值，Nginx就认为服务器不可用。在下一个fail_timeout时间段，服务器不会再被尝试。</span> <span class="string">失败的尝试次数默认是1。设为0就会停止统计尝试次数，认为服务器是一直可用的。</span> <span class="string">你可以通过指令proxy_next_upstream、</span> <span class="string">fastcgi_next_upstream和memcached_next_upstream来配置什么是失败的尝试。</span> <span class="string">默认配置时，http_404状态不被认为是失败的尝试。fail_timeout=time设定</span></span><br><span class="line"></span><br><span class="line"><span class="string">统计失败尝试次数的时间段。在这段时间中，服务器失败次数达到指定的尝试次数，服务器就被认为不可用。</span></span><br><span class="line"><span class="string">服务器被认为不可用的时间段。</span></span><br><span class="line"><span class="string">默认情况下，该超时时间是10秒。backup标记为备用服务器。当主服务器不可用以后，请求会被传给这些服务器。down标记服务器永久不可用，可以跟ip_hash指令一起使用。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Example:</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="string">backend1.example.com</span>     <span class="string">weight=5;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span>           <span class="string">max_fails=3</span> <span class="string">fail_timeout=30s;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">unix:/tmp/backend3;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> <span class="string">backup1.example.com:8080</span> <span class="string">backup;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">语法:</span>	<span class="string">ip_hash;</span></span><br><span class="line"><span class="string">默认值:</span>	<span class="string">—</span></span><br><span class="line"><span class="string">上下文:</span>	<span class="string">upstream</span></span><br><span class="line"><span class="string">指定服务器组的负载均衡方法，请求基于客户端的IP地址在服务器间进行分发。</span> <span class="string">IPv4地址的前三个字节或者IPv6的整个地址，会被用来作为一个散列key。</span> <span class="string">这种方法可以确保从同一个客户端过来的请求，会被传给同一台服务器。除了当服务器被认为不可用的时候，这些客户端的请求会被传给其他服务器，而且很有可能也是同一台服务器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">从1.3.2和1.2.2版本开始支持IPv6地址。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果其中一个服务器想暂时移除，应该加上down参数。这样可以保留当前客户端IP地址散列分布。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例子：</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">ip_hash;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> <span class="string">backend1.example.com;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">backend2.example.com;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">backend3.example.com</span> <span class="string">down;</span></span><br><span class="line">    <span class="string">server</span> <span class="string">backend4.example.com;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">从1.3.1和1.2.2版本开始，ip_hash的负载均衡方法才支持设置服务器权重值。</span></span><br><span class="line"></span><br><span class="line"><span class="string">语法:</span>	<span class="string">keepalive</span> <span class="string">connections;</span></span><br><span class="line"><span class="string">默认值:</span>	<span class="string">—</span></span><br><span class="line"><span class="string">上下文:</span>	<span class="string">upstream</span></span><br><span class="line"><span class="string">这个指令出现在版本</span> <span class="number">1.1</span><span class="number">.4</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">激活对上游服务器的连接进行缓存。</span></span><br><span class="line"></span><br><span class="line"><span class="string">connections参数设置每个worker进程与后端服务器保持连接的最大数量。这些保持的连接会被放入缓存。</span> <span class="string">如果连接数大于这个值时，最久未使用的连接会被关闭。</span></span><br><span class="line"></span><br><span class="line"><span class="string">需要注意的是，keepalive指令不会限制Nginx进程与上游服务器的连接总数。</span> <span class="string">新的连接总会按需被创建。</span> <span class="string">connections参数应该稍微设低一点，以便上游服务器也能处理额外新进来的连接。</span></span><br><span class="line"></span><br><span class="line"><span class="string">配置memcached上游服务器连接keepalive的例子：</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">memcached_backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:11211;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span><span class="string">:11211;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive</span> <span class="number">32</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/memcached/</span> &#123;</span><br><span class="line">        <span class="string">set</span> <span class="string">$memcached_key</span> <span class="string">$uri;</span></span><br><span class="line">        <span class="string">memcached_pass</span> <span class="string">memcached_backend;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">对于HTTP代理，proxy_http_version指令应该设置为“1.1”，同时“Connection”头的值也应被清空。</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">http_backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive</span> <span class="number">16</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/http/</span> &#123;</span><br><span class="line">        <span class="string">proxy_pass</span> <span class="string">http://http_backend;</span></span><br><span class="line">        <span class="string">proxy_http_version</span> <span class="number">1.1</span><span class="string">;</span></span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">Connection</span> <span class="string">&quot;&quot;</span><span class="string">;</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">另外一种选择是，HTTP/1.0协议的持久连接也可以通过发送“Connection:</span> <span class="string">Keep-Alive”头来实现。不过不建议这样用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">对于FastCGI的服务器，需要设置</span> <span class="string">fastcgi_keep_conn</span> <span class="string">指令来让连接keepalive工作：</span></span><br><span class="line"></span><br><span class="line"><span class="string">upstream</span> <span class="string">fastcgi_backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">keepalive</span> <span class="number">8</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/fastcgi/</span> &#123;</span><br><span class="line">        <span class="string">fastcgi_pass</span> <span class="string">fastcgi_backend;</span></span><br><span class="line">        <span class="string">fastcgi_keep_conn</span> <span class="string">on;</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">当使用的负载均衡方法不是默认的轮转法时，必须在keepalive</span> <span class="string">指令之前配置。</span></span><br><span class="line"></span><br><span class="line"><span class="string">针对SCGI和uwsgi协议，还没有实现其keepalive连接的打算。</span></span><br><span class="line"></span><br><span class="line"><span class="string">语法:</span>	<span class="string">least_conn;</span></span><br><span class="line"><span class="string">默认值:</span>	<span class="string">—</span></span><br><span class="line"><span class="string">上下文:</span>	<span class="string">upstream</span></span><br><span class="line"><span class="string">这个指令出现在版本</span> <span class="number">1.3</span><span class="number">.1</span> <span class="string">和</span> <span class="number">1.2</span><span class="number">.2</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">指定服务器组的负载均衡方法，根据其权重值，将请求发送到活跃连接数最少的那台服务器。</span> <span class="string">如果这样的服务器有多台，那就采取有权重的轮转法进行尝试。</span></span><br><span class="line"></span><br><span class="line"><span class="string">嵌入的变量</span></span><br><span class="line"><span class="string">ngx_http_upstream_module模块支持以下嵌入变量：</span></span><br><span class="line"></span><br><span class="line"><span class="string">$upstream_addr保存服务器的IP地址和端口或者是UNIX域套接字的路径。</span> <span class="string">在请求处理过程中，如果有多台服务器被尝试了，它们的地址会被拼接起来，以逗号隔开，比如：</span> <span class="string">“192.168.1.1:80,</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span><span class="string">:80,</span> <span class="string">unix:/tmp/sock”。</span> <span class="string">如果在服务器之间通过“X-Accel-Redirect”头或者error_page有内部跳转，那么这些服务器组之间会以冒号隔开，比如：“192.168.1.1:80,</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.2</span><span class="string">:80,</span> <span class="attr">unix:/tmp/sock :</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span><span class="string">:80,</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.2</span><span class="string">:80”。$upstream_response_time以毫秒的精度保留服务器的响应时间，（输出）单位是秒。</span> <span class="string">出现多个响应时，也是以逗号和冒号隔开。$upstream_status保存服务器的响应代码。</span> <span class="string">出现多个响应时，也是以逗号和冒号隔开。$upstream_http_...保存服务器的响应头的值。比如“Server”响应头的值可以通过$upstream_http_server变量来获取。</span> <span class="string">需要注意的是只有最后一个响应的头会被保留下来。</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx-rewrite-指令"><a href="#nginx-rewrite-指令" class="headerlink" title="nginx rewrite 指令"></a>nginx rewrite 指令</h1><p>nginx通过ngx_http_rewrite_module模块支持url重写、支持if条件判断，但不支持else。</p>
<p>该模块需要PCRE支持，应在编译nginx时指定PCRE源码目录, <a target="_blank" rel="noopener" href="http://www.nginx.cn/install">nginx安装方法</a>。</p>
<h3 id="nginx-rewrite指令执行顺序："><a href="#nginx-rewrite指令执行顺序：" class="headerlink" title="nginx rewrite指令执行顺序："></a><strong>nginx rewrite指令执行顺序：</strong></h3><p>1.执行server块的rewrite指令(这里的块指的是server关键字后{}包围的区域，其它xx块类似)<br>2.执行location匹配<br>3.执行选定的location中的rewrite指令<br>如果其中某步URI被重写，则重新循环执行1-3，直到找到真实存在的文件</p>
<p>如果循环超过10次，则返回500 Internal Server Error错误</p>
<h3 id="break指令"><a href="#break指令" class="headerlink" title="break指令"></a>break指令</h3><p>语法：break;<br>默认值：无<br>作用域：server,location,if</p>
<p>停止执行当前虚拟主机的后续rewrite指令集<br>break指令实例：</p>
<table>
<thead>
<tr>
<th>1234</th>
<th>if ($slow) {   limit_rate 10k;   break; }</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a><strong>if指令</strong></h3><p>语法：if(condition){…}<br>默认值：无<br>作用域：server,location<br>对给定的条件condition进行判断。如果为真，大括号内的rewrite指令将被执行。<br>if条件(conditon)可以是如下任何内容:</p>
<ul>
<li>一个变量名；false如果这个变量是空字符串或者以0开始的字符串；</li>
<li>使用= ,!= 比较的一个变量和字符串</li>
<li>是用~， ~*与正则表达式匹配的变量，如果这个正则表达式中包含}，;则整个表达式需要用” 或’ 包围</li>
<li>使用-f ，!-f 检查一个文件是否存在</li>
<li>使用-d, !-d 检查一个目录是否存在</li>
<li>使用-e ，!-e 检查一个文件、目录、符号链接是否存在</li>
<li>使用-x ， !-x 检查一个文件是否可执行</li>
</ul>
<p>if指令实例</p>
<table>
<thead>
<tr>
<th>12345678910111213141516171819</th>
<th>if ($http_user_agent ~ MSIE) {   rewrite ^(.<em>)$ /msie/$1 break; } if ($http_cookie ~</em> “id=([^;]+)(?:;|$)”) {   set $id $1; } if ($request_method = POST) {   return 405; } if ($slow) {   limit_rate 10k; } if ($invalid_referer) {   return 403; }</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="return指令"><a href="#return指令" class="headerlink" title="return指令"></a><strong>return指令</strong></h3><p>语法：return code;</p>
<p>return code URL;</p>
<p><em>return URL;<br>默认值：无<br>作用域：server,location,if</em></p>
<p>停止处理并返回指定状态码(code)给客户端。<br>非标准状态码444表示关闭连接且不给客户端发响应头。<br>从0.8.42版本起，return 支持响应URL重定向(对于301，302，303，307），或者文本响应(对于其他状态码).<br>对于文本或者URL重定向可以包含变量</p>
<h3 id="rewrite指令"><a href="#rewrite指令" class="headerlink" title="rewrite指令"></a><strong>rewrite指令</strong></h3><p>语法：rewrite regex replacement [flag];<br>默认值：无<br>作用域：server,location,if<br>如果一个URI匹配指定的正则表达式regex，URI就按照replacement重写。<br>rewrite按配置文件中出现的顺序执行。flags标志可以停止继续处理。<br>如果replacement以”http://“或”https://“开始，将不再继续处理，这个重定向将返回给客户端。<br>flag可以是如下参数<br>last 停止处理后续rewrite指令集，然后对当前重写的新URI在rewrite指令集上重新查找。<br>break 停止处理后续rewrite指令集，并不在重新查找,但是当前location内剩余非rewrite语句和location外的的非rewrite语句可以执行。<br>redirect 如果replacement不是以http:// 或https://开始，返回302临时重定向<br>permant 返回301永久重定向<br>最终完整的重定向URL包括请求scheme(http://,https://等),请求的server_name_in_redirect和 port_in_redirec三部分 ，说白了也就是http协议 域名 端口三部分组成。</p>
<p>rewrite实例</p>
<table>
<thead>
<tr>
<th>1234567</th>
<th>server {   …   rewrite ^(/download/.<em>)/media/(.</em>)..<em>$ $1/mp3/$2.mp3 last;   rewrite ^(/download/.</em>)/audio/(.<em>)..</em>$ $1/mp3/$2.ra last;   return 403;   … }</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>如果这些rewrite放到 “<code>/download/</code>” location如下所示, 那么应使用break而不是last , 使用last将循环10次匹配，然后返回 500错误:</p>
<table>
<thead>
<tr>
<th>12345</th>
<th>location /download/ {   rewrite ^(/download/.<em>)/media/(.</em>)..<em>$ $1/mp3/$2.mp3 break;   rewrite ^(/download/.</em>)/audio/(.<em>)..</em>$ $1/mp3/$2.ra break;   return 403; }</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>对于重写后的URL（replacement）包含原请求的请求参数，原URL的?后的内容。如果不想带原请求的参数 ，可以在replacement后加一个问号。如下，我们加了一个自定义的参数user=$1,然后在结尾处放了一个问号?,把原请的参数去掉。</p>
<table>
<thead>
<tr>
<th>1</th>
<th>rewrite ^/users/(.*)$ /show?user=$1? last;</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>如果正则表达regex式中包含 “<code>&#125;</code>” 或 “<code>;</code>”, 那么整个表达式需要用双引号或单引号包围.</p>
<h3 id="rewrite-log指令"><a href="#rewrite-log指令" class="headerlink" title="rewrite_log指令"></a><strong>rewrite_log指令</strong></h3><p>语法：rewrite_log on|off;<br>默认值：rewrite_log off;<br>作用域：http,server,location,if<br>开启或关闭以notice级别打印rewrite处理日志到error log文件。</p>
<p>nginx打开rewrite log例子</p>
<p>rewrite_log on;<br>error_log logs/xxx.error.log notice;</p>
<p>1.打开rewrite on<br>2.把error log的级别调整到 notice</p>
<h3 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a><strong>set指令</strong></h3><p>语法：set variable value;<br>默认值：none<br>作用域：server,location,if<br>定义一个变量并赋值，值可以是文本，变量或者文本变量混合体。</p>
<h3 id="uninitialized-variable-warn指令"><a href="#uninitialized-variable-warn指令" class="headerlink" title="uninitialized_variable_warn指令"></a><strong>uninitialized_variable_warn指令</strong></h3><p>语法：uninitialized_variable_warn on | off;<br>默认值：uninitialized_variable_warn on<br>作用域：http,server,location,if</p>
<p>控制是否输出为初始化的变量到日志</p>
<h1 id="nginx的虚拟主机功能（nginx多站点，绑定多个域名）"><a href="#nginx的虚拟主机功能（nginx多站点，绑定多个域名）" class="headerlink" title="nginx的虚拟主机功能（nginx多站点，绑定多个域名）"></a>nginx的虚拟主机功能（nginx多站点，绑定多个域名）</h1><h2 id="两个虚拟主机-纯静态-html-支持-Two-Virtual-Hosts-Serving-Static-Files"><a href="#两个虚拟主机-纯静态-html-支持-Two-Virtual-Hosts-Serving-Static-Files" class="headerlink" title="两个虚拟主机(纯静态-html 支持) - Two Virtual Hosts, Serving Static Files"></a>两个虚拟主机(纯静态-html 支持) - Two Virtual Hosts, Serving Static Files</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>          <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">server_name</span>     <span class="string">www.domain1.com;</span></span><br><span class="line">        <span class="string">access_log</span>      <span class="string">logs/domain1.access.log</span> <span class="string">main;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">index</span> <span class="string">index.html;</span></span><br><span class="line">            <span class="string">root</span>  <span class="string">/var/www/domain1.com/htdocs;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>          <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">server_name</span>     <span class="string">www.domain2.com;</span></span><br><span class="line">        <span class="string">access_log</span>      <span class="string">logs/domain2.access.log</span> <span class="string">main;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">index</span> <span class="string">index.html;</span></span><br><span class="line">            <span class="string">root</span>  <span class="string">/var/www/domain2.com/htdocs;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">虚拟主机标准配置(简化)</span> <span class="bullet">-</span> <span class="string">A</span> <span class="string">Default</span> <span class="string">Catchall</span> <span class="string">Virtual</span> <span class="string">Host</span></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span>          <span class="number">80</span> <span class="string">default;</span></span><br><span class="line">        <span class="string">server_name</span>     <span class="string">_</span> <span class="string">*;</span></span><br><span class="line">        <span class="string">access_log</span>      <span class="string">logs/default.access.log</span> <span class="string">main;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">index</span> <span class="string">index.html;</span></span><br><span class="line">            <span class="string">root</span>  <span class="string">/var/www/default/htdocs;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">在父文件夹中建立子文件夹以指向子域名</span> <span class="bullet">-</span> <span class="string">Wildcard</span> <span class="string">Subdomains</span> <span class="string">in</span> <span class="string">a</span> <span class="string">Parent</span> <span class="string">Folder</span></span><br><span class="line"><span class="string">这是一个添加子域名(或是当DNS已指向服务器时添加一个新域名)的简单方法。需要注意的是，我已经将FCGI配置进该文件了。如果你只想使服务器为静态文件服务，可以直接将FCGI配置信息注释掉，然后将默认主页文件变成index.html。</span></span><br><span class="line"></span><br><span class="line"><span class="string">这个简单的方法比起为每一个域名建立一个</span> <span class="string">vhost.conf</span> <span class="string">配置文件来讲，只需要在现有的配置文件中增加如下内容：</span></span><br><span class="line"></span><br><span class="line"><span class="string">This</span> <span class="string">is</span> <span class="string">just</span> <span class="string">a</span> <span class="string">really</span> <span class="string">easy</span> <span class="string">way</span> <span class="string">to</span> <span class="string">keep</span> <span class="string">adding</span> <span class="string">new</span> <span class="string">subdomains,</span> <span class="string">or</span> <span class="string">to</span> <span class="string">add</span> <span class="string">new</span> <span class="string">domains</span> <span class="string">automatically</span> <span class="string">when</span> <span class="string">DNS</span> <span class="string">records</span> <span class="string">are</span> <span class="string">pointed</span> <span class="string">at</span> <span class="string">the</span> <span class="string">server.</span> <span class="string">Note</span> <span class="string">that</span> <span class="string">I</span> <span class="string">have</span> <span class="string">included</span> <span class="string">FCGI</span> <span class="string">here</span> <span class="string">as</span> <span class="string">well.</span> <span class="string">If</span> <span class="string">you</span> <span class="string">want</span> <span class="string">to</span> <span class="string">just</span> <span class="string">serve</span> <span class="string">static</span> <span class="string">files,</span> <span class="string">strip</span> <span class="string">out</span> <span class="string">the</span> <span class="string">FCGI</span> <span class="string">config</span> <span class="string">and</span> <span class="string">change</span> <span class="string">the</span> <span class="string">default</span> <span class="string">document</span> <span class="string">to</span> <span class="string">index.html.</span> <span class="string">Rather</span> <span class="string">than</span> <span class="string">creating</span> <span class="string">a</span> <span class="string">new</span> <span class="string">vhost.conf</span> <span class="string">file</span> <span class="string">for</span> <span class="string">every</span> <span class="string">domain,</span> <span class="attr">just create one of these:</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">        <span class="comment"># Replace this port with the right one for your requirements</span></span><br><span class="line">        <span class="comment"># 根据你的需求改变此端口</span></span><br><span class="line">        <span class="string">listen</span>       <span class="number">80</span><span class="string">;</span>  <span class="comment">#could also be 1.2.3.4:80 也可以是1.2.3.4:80的形式</span></span><br><span class="line">        <span class="comment"># Multiple hostnames seperated by spaces.  Replace these as well.</span></span><br><span class="line">        <span class="comment"># 多个主机名可以用空格隔开，当然这个信息也是需要按照你的需求而改变的。</span></span><br><span class="line">        <span class="string">server_name</span>  <span class="string">star.yourdomain.com</span> <span class="string">*.yourdomain.com</span> <span class="string">www.*.yourdomain.com;</span></span><br><span class="line">        <span class="comment">#Alternately: _ *</span></span><br><span class="line">        <span class="comment">#或者可以使用：_ * (具体内容参见本维基其他页面)</span></span><br><span class="line">        <span class="string">root</span> <span class="string">/PATH/TO/WEBROOT/$host;</span></span><br><span class="line">        <span class="string">error_page</span>  <span class="number">404</span>              <span class="string">http://yourdomain.com/errors/404.html;</span></span><br><span class="line">        <span class="string">access_log</span>  <span class="string">logs/star.yourdomain.com.access.log;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">root</span>   <span class="string">/PATH/TO/WEBROOT/$host/;</span></span><br><span class="line">            <span class="string">index</span>  <span class="string">index.php;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># serve static files directly</span></span><br><span class="line">        <span class="comment"># 直接支持静态文件 (爱月说：???从配置上看来不是直接支持啊～有问题有问题～)</span></span><br><span class="line">        <span class="string">location</span> <span class="string">~*</span> <span class="string">^.+.(jpg|jpeg|gif|css|png|js|ico|html)$</span> &#123;</span><br><span class="line">            <span class="string">access_log</span>        <span class="string">off;</span></span><br><span class="line">            <span class="string">expires</span>           <span class="string">30d;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.php$</span> &#123;</span><br><span class="line">          <span class="comment"># By all means use a different server for the fcgi processes if you need to</span></span><br><span class="line">          <span class="comment"># 如果需要，你可以为不同的FCGI进程设置不同的服务信息</span></span><br><span class="line">          <span class="string">fastcgi_pass</span>   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:YOURFCGIPORTHERE;</span></span><br><span class="line">          <span class="string">fastcgi_index</span>  <span class="string">index.php;</span></span><br><span class="line">          <span class="string">fastcgi_param</span>  <span class="string">SCRIPT_FILENAME</span>  <span class="string">/PATH/TO/WEBROOT/$host/$fastcgi_script_name;</span></span><br><span class="line">          <span class="string">fastcgi_param</span>  <span class="string">QUERY_STRING</span>     <span class="string">$query_string;</span></span><br><span class="line">          <span class="string">fastcgi_param</span>  <span class="string">REQUEST_METHOD</span>   <span class="string">$request_method;</span></span><br><span class="line">          <span class="string">fastcgi_param</span>  <span class="string">CONTENT_TYPE</span>     <span class="string">$content_type;</span></span><br><span class="line">          <span class="string">fastcgi_param</span>  <span class="string">CONTENT_LENGTH</span>   <span class="string">$content_length;</span></span><br><span class="line">          <span class="string">fastcgi_intercept_errors</span> <span class="string">on;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">/.ht</span> &#123;</span><br><span class="line">            <span class="string">deny</span>  <span class="string">all;</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>



<h1 id="如何使用nginx配置负载均衡"><a href="#如何使用nginx配置负载均衡" class="headerlink" title="如何使用nginx配置负载均衡"></a>如何使用nginx配置负载均衡</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">负载均衡是扩展应用程序并提高其性能和冗余的绝佳方法。Nginx是一种流行的Web服务器软件，可以配置为简单但功能强大的负载均衡器，以提高服务器资源的可用性和效率。在负载</span> <span class="string">均衡配置中，nginx充当在多个单独服务器上工作的分布式Web应用程序的单个入口点。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在Web场上进行负载平衡</span></span><br><span class="line"><span class="string">本文介绍如何使用nginx为云服务器配置负载均衡。作为先决条件，您需要至少安装两台主机并安装Web服务器软件，以便了解负载均衡器的优势。</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装nginx</span></span><br><span class="line"><span class="string">目前，最新版本的CentOS，Debian和Ubuntu都提供nginx软件包，可以使用命令快速安装nginx。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Debian和Ubuntu </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">update</span> </span><br><span class="line"><span class="comment">#然后安装Nginx开源版 </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Debian和Ubuntu </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">update</span> </span><br><span class="line"><span class="comment">#然后安装Nginx开源版 </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line"><span class="comment">#CentOS </span></span><br><span class="line"><span class="comment">#安装额外的软件包存储库 </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">epel-release</span></span><br><span class="line"><span class="comment">#更新存储库并安装Nginx </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">update</span> </span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS </span></span><br><span class="line"><span class="comment">#安装额外的软件包存储库 </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">epel-release</span></span><br><span class="line"><span class="comment">#更新存储库并安装Nginx </span></span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">update</span> </span><br><span class="line"><span class="string">sudo</span> <span class="string">yum</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">安装完成后，进入nginx主配置文件夹。</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/etc/nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="string">根据您的操作系统不同，Web服务器配置文件将位于两个位置之一。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Ubuntu和Debian遵循在</span> <span class="string">/etc/nginx/sites-available/中存储虚拟主机文件的规则，这些规则通过符号链接到</span> <span class="string">/etc/nginx/sites-enabled/来启用。可以使用以下命令启用任何新的虚拟主机文件。</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">ln</span> <span class="string">-s</span> <span class="string">/etc/nginx/sites-available/vhost</span> <span class="string">/etc/nginx/sites-enabled/vhost</span></span><br><span class="line"></span><br><span class="line"><span class="string">CentOS用户可以在/etc/nginx/conf.d/下找到其主机配置文件，nginx会加载此文件加下所有.conf类型的虚拟主机文件。可以在这个目录中至少找到一个默认配置default.conf，然后重新启动nginx。</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">通过在Web浏览器中打开负载均衡服务器的IP地址来测试服务器是否回复HTTP请求。当您看到nginx的默认欢迎页面时，nginx安装成功。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Nginx默认欢迎页面。</span></span><br><span class="line"><span class="string">如果您在加载页面时遇到问题，请检查防火墙是否阻止了您的连接。例如，在CentOS</span> <span class="number">7</span><span class="string">上，默认防火墙规则不允许HTTP流量，请使用以下命令启用它。</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">firewall-cmd</span> <span class="string">--add-service=http</span> <span class="string">--permanent</span> </span><br><span class="line"><span class="string">sudo</span> <span class="string">firewall-cmd</span> <span class="string">--reload</span></span><br><span class="line"></span><br><span class="line"><span class="string">然后尝试刷新浏览器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">将nginx配置为负载均衡器</span></span><br><span class="line"><span class="string">安装并测试nginx后，您可以开始配置nginx以实现负载平衡功能。从本质上讲，需要做的就是设置nginx，其中包含要监听的连接类型以及重定向位置的说明。要实现此目的，请使用您喜欢的任何文本编辑器创建新的配置文件，例如使用vi：</span></span><br><span class="line"></span><br><span class="line"><span class="string">sudo</span> <span class="string">vi</span> <span class="string">/etc/nginx/conf.d/load-balancer.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">在load-balancer.conf中，您需要定义以下两个段：upstream</span> <span class="string">和server</span> <span class="string">，请参阅下面的示例。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义要包含在负载均衡方案中的服务器。  </span></span><br><span class="line"><span class="comment">#最好使用服务器的私有IP以获得更好的性能和安全性。 </span></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">       <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.101</span><span class="string">;</span></span><br><span class="line">       <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.102</span><span class="string">;</span></span><br><span class="line">       <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.103</span><span class="string">;</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">#该服务器接受到端口80的所有流量并将其传递给上游upstream 。</span></span><br><span class="line">    <span class="comment">#请注意，upstream名称和proxy_pass需要匹配。</span></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">       <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">           <span class="string">proxy_pass</span> <span class="string">http://backend;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">然后保存文件并退出编辑器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">接下来，您需要禁用先前在安装后测试的默认服务器配置。同样取决于您的操作系统，这部分略有不同。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在Debian和Ubuntu系统上，您需要从启用站点的文件夹中删除默认符号链接。</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">rm</span> <span class="string">/etc/nginx/sites-enabled/default</span></span><br><span class="line"></span><br><span class="line"><span class="string">CentOS的主机不使用相同的链接，而是简单地将重命名default.conf在conf.d</span> <span class="string">/目录下的东西，不是结束的.conf，例如：</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">mv</span> <span class="string">/etc/nginx/conf.d/default.conf</span> <span class="string">/etc/nginx/conf.d/default.conf.disabled</span></span><br><span class="line"></span><br><span class="line"><span class="string">然后使用以下命令重新启动nginx</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">检查nginx是否成功启动。如果重新启动失败，请查看刚刚创建的</span>  <span class="string">/etc/nginx/conf.d/load-balancer.conf，以确保没有错误类型或缺少分号。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在Web浏览器中输入负载均衡nginx的IP地址时，请求会被传递到后端其中一个服务器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">负载均衡方法</span></span><br><span class="line"><span class="string">如果没有定义其他方法，默认情况下nginx负载均衡会使用循环算法，如上面的第一个示例所示。使用循环方案，将根据您在load-balancer.conf</span>  <span class="string">文件中设置的顺序轮流选择每个服务器。这平衡了短期操作的请求数量。</span></span><br><span class="line"></span><br><span class="line"><span class="string">基于最少连接的负载均衡是另一种简单的方法。顾名思义，此方法将请求定向到当时具有最少活动连接的服务器。对于请求有时可能需要更长时间才能完成的应用程序，它比循环法更有效。</span></span><br><span class="line"></span><br><span class="line"><span class="string">要启用最少连接均衡方法，请将参数least_conn添加到上游</span>  <span class="string">部分，如下例所示。</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">least_conn;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.101</span><span class="string">;</span></span><br><span class="line">     <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.102</span><span class="string">;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.103</span><span class="string">;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">虽然循环和最少连接平衡方案是公平的并且有其用途，但是它们不能提供会话持久性。如果您的Web应用程序要求用户随后被定向到与之前连接相同的后端服务器，则应使用IPhash方法。IPhash使用访问者IP地址作为密钥来确定应选择哪个主机来为请求提供服务。这允许访问者每次被定向到同一服务器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">要使用此方法，请将ip_hash</span> <span class="string">添加到</span> <span class="string">upstream</span> <span class="string">段，如下面的示例所示。</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">ip_hash;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.101</span><span class="string">;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.102</span><span class="string">;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.103</span><span class="string">;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">在一组主机之间的可用资源不相等的服务器配置中，可能希望某些服务器优先于其它服务器。定义服务器权重允许您进一步微调</span> <span class="string">nginx</span> <span class="string">负载均衡。负载均衡中权重最高的服务器最常选择。</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.101</span> <span class="string">weight=4;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.102</span> <span class="string">weight=2;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.103</span><span class="string">;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">例如，在上面的配置中，第一个服务器的选择频率是第二个服务器的两倍，是第三个服务器的四倍。</span></span><br><span class="line"></span><br><span class="line"><span class="string">启用HTTPS的负载均衡</span></span><br><span class="line"><span class="string">为您的网站启用HTTPS是保护访问者及其数据的好方法。建议大家开启https，可以提高搜索排名。了解如何在nginx上安装Let&#x27;s</span> <span class="string">Encrypt。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在负载均衡器中使用https加密比想象的要容易。需要做的就是在负载均衡器配置文件中添加另一个服务器server，该server使用SSL监听端口443上的HTTPS流量，并为</span> <span class="string">upstream</span> <span class="string">段设置</span> <span class="string">proxy_pass</span> <span class="string">，就像上一个示例中的HTTP一样。</span></span><br><span class="line"></span><br><span class="line"><span class="string">再次打开配置文件进行编辑。</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">vi</span> <span class="string">/etc/nginx/conf.d/load-balancer.conf</span></span><br><span class="line"><span class="string">然后将以下服务器段添加到文件末尾。</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">listen</span> <span class="number">443</span> <span class="string">ssl;</span></span><br><span class="line">    <span class="string">server_name</span> <span class="string">domain_name;</span></span><br><span class="line">    <span class="string">ssl_certificate</span> <span class="string">/etc/letsencrypt/live/domain_name/cert.pem;</span></span><br><span class="line">    <span class="string">ssl_certificate_key</span> <span class="string">/etc/letsencrypt/live/domain_name/privkey.pem;</span></span><br><span class="line">    <span class="string">ssl_protocols</span> <span class="string">TLSv1</span> <span class="string">TLSv1.1</span> <span class="string">TLSv1.2;</span></span><br><span class="line">    <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">       <span class="string">proxy_pass</span> <span class="string">http://backend;</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">然后保存文件，退出编辑器并再次重新启动nginx。</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">健康检查</span></span><br><span class="line"><span class="string">为了知道哪些服务器可用，nginx的反向代理实现包括被动服务器健康检查。如果服务器无法响应请求或回复错误，nginx会检测到服务失败，并将尝试一段时间内避免转发请求到该服务器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过将参数max_fails设置为服务器行，可以在负载均衡器配置文件中定义特定时间段内连续不成功的连接尝试次数。默认情况下，如果未指定max_fails，则将此值设置为1.（可选）将max_fails设置为0将禁用对该服务器的运行状况检查。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果将max_fails设置为大于1的值，则后续失败必须在特定时间范围内发生，以便无法计数。此时间范围由参数fail_timeout指定，该参数还定义服务器应被视为失败的时间。默认情况下，fail_timeout设置为10秒。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在服务器标记失败并且fail_timeout设置的时间已过后，nginx将开始使用客户端请求正常探测服务器。如果探测返回成功，则服务器再次标记为可用并且正常包含在负载平衡中。</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">backend</span> &#123;</span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.101</span> <span class="string">weight=5;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.102</span> <span class="string">max_fails=3</span> <span class="string">fail_timeout=30s;</span></span><br><span class="line">    <span class="string">server</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.103</span><span class="string">;</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="string">使用运行状况检查可以根据需要通过启动或关闭主机来使服务器后端适应当前需求。在高流量期间启动其他服务器可以在新资源自动供负载均衡器使用时轻松提高应用程序性能。</span></span><br><span class="line"></span><br><span class="line"><span class="string">结论</span></span><br><span class="line"><span class="string">如果您希望提高Web应用程序的性能和可用性，那么设置负载均衡器绝对值得考虑。使用nginx进行负载均衡功能强大且设置相对简单，并且与简单的加密解决方案（例如Let&#x27;s</span> <span class="string">Encrypt客户端）一起使用，它为您的Web场提供了一个很好的前端。</span></span><br><span class="line"></span><br><span class="line"><span class="string">虽然使用多个主机可以保护您的Web服务具有冗余，但负载均衡器本身仍然可能单点故障。您可以通过在多个nginx之间设置浮动IP来进一步提高高可用性。</span></span><br></pre></td></tr></table></figure>



<h1 id="使用nginx的proxy-cache做网站缓存"><a href="#使用nginx的proxy-cache做网站缓存" class="headerlink" title="使用nginx的proxy_cache做网站缓存"></a>使用nginx的proxy_cache做网站缓存</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">为什么要做web</span> <span class="string">cache，我想大家最主要的是解决流量的压力。随着网站流量的提升，如果只是单台机器既处理静态文件，又处理动态脚本，显然效率很难上升，不能处理日益上涨的流量压力。与此同时某些网站的页面内容并不是经常变化，因此我们可以分两层架构来组织网站。前端web缓存+后端web服务器，可以参看这里配置nginx反向代理配置</span></span><br><span class="line"></span><br><span class="line"><span class="string">前端web缓存有多重方式实现，原理就是队请求结果页面静态化并设置一个超时期限，缓存页面过期后，新请求到达时重新到后端web服务器获取内容更新；没有nginx前比较流行的方法是squid，但squid不能充分利用处理器的多核特性，越来越多的网站选用nginx来做前端的web缓存。</span></span><br><span class="line"></span><br><span class="line"><span class="string">要想使用nginx的缓存功能要保证nginx添加了proxy模块。我们可以使用-V选项(大写的V，小写的v是看版本号的)来查看nginx的编译参数。我使用的是默认的参数编译的，如下所示：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">root@SNDA-172-17-12-117:/usr/local/nginx#</span> <span class="string">./nginx</span> <span class="string">-V</span></span><br><span class="line"><span class="attr">nginx version:</span> <span class="string">nginx/1.2.3</span></span><br><span class="line"><span class="string">built</span> <span class="string">by</span> <span class="string">gcc</span> <span class="number">4.4</span><span class="number">.3</span> <span class="string">(Ubuntu</span> <span class="number">4.4</span><span class="number">.3</span><span class="string">-4ubuntu5.1)</span></span><br><span class="line"><span class="string">TLS</span> <span class="string">SNI</span> <span class="string">support</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">configure arguments:</span> <span class="string">--sbin-path=/usr/local/nginx/nginx</span> <span class="string">--conf-path=/usr/local/nginx/nginx.conf</span> <span class="string">--pid-path=/usr/local/nginx/nginx.pid</span> <span class="string">--with-http_ssl_module</span> <span class="string">--with-pcre=/usr/local/src/pcre-8.21</span> <span class="string">--with-zlib=/usr/local/src/zlib-1.2.7</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx的所有模块必须在编译的时候添加，不能再运行的时候动态加载，默认的编译选项下包含的模块，如果你不是显示的用参数关闭它。</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx默认安装的模块如下</span></span><br><span class="line"></span><br><span class="line"><span class="string">模块名称</span>	<span class="string">描述</span>	<span class="string">版本</span>	<span class="string">如何禁用</span></span><br><span class="line"><span class="string">Core</span>	<span class="string">Control</span> <span class="string">ports,</span> <span class="string">locations,</span> <span class="string">error</span> <span class="string">pages,</span> <span class="string">aliases,</span> <span class="string">and</span> <span class="string">other</span> <span class="string">essentials.</span>		<span class="string">--without-http</span></span><br><span class="line"><span class="string">Access</span>	<span class="string">Allow/deny</span> <span class="string">based</span> <span class="string">on</span> <span class="string">IP</span> <span class="string">address.</span>		<span class="string">--without-http_access_module</span></span><br><span class="line"><span class="string">Auth</span> <span class="string">Basic</span>	<span class="string">Basic</span> <span class="string">HTTP</span> <span class="string">authentication.</span>		<span class="string">--without-http_auth_basic_module</span></span><br><span class="line"><span class="string">Auto</span> <span class="string">Index</span>	<span class="string">Generates</span> <span class="string">automatic</span> <span class="string">directory</span> <span class="string">listings.</span>		<span class="string">--without-http_autoindex_module</span></span><br><span class="line"><span class="string">Browser</span>	<span class="string">Interpret</span> <span class="string">&quot;User-Agent&quot;</span> <span class="string">string.</span>	<span class="number">0.4</span><span class="number">.3</span>	<span class="string">--without-http_browser_module</span></span><br><span class="line"><span class="string">Charset</span>	<span class="string">Recode</span> <span class="string">web</span> <span class="string">pages.</span>		<span class="string">--without-http_charset_module</span></span><br><span class="line"><span class="string">Empty</span> <span class="string">GIF</span>	<span class="string">Serve</span> <span class="string">a</span> <span class="string">1x1</span> <span class="string">image</span> <span class="string">from</span> <span class="string">memory.</span>	<span class="number">0.3</span><span class="number">.10</span>	<span class="string">--without-http_empty_gif_module</span></span><br><span class="line"><span class="string">FastCGI</span>	<span class="string">FastCGI</span> <span class="string">Support.</span>		<span class="string">--without-http_fastcgi_module</span></span><br><span class="line"><span class="string">Geo</span>	<span class="string">Set</span> <span class="string">config</span> <span class="string">variables</span> <span class="string">using</span> <span class="string">key/value</span> <span class="string">pairs</span> <span class="string">of</span> <span class="string">IP</span> <span class="string">addresses.</span>	<span class="number">0.1</span><span class="number">.17</span>	<span class="string">--without-http_geo_module</span></span><br><span class="line"><span class="string">Gzip</span>	<span class="string">Gzip</span> <span class="string">responses.</span>		<span class="string">--without-http_gzip_module</span></span><br><span class="line"><span class="string">Headers</span>	<span class="string">Set</span> <span class="string">arbitrary</span> <span class="string">HTTP</span> <span class="string">response</span> <span class="string">headers.</span>	</span><br><span class="line"><span class="string">Index</span>	<span class="string">Controls</span> <span class="string">which</span> <span class="string">files</span> <span class="string">are</span> <span class="string">to</span> <span class="string">be</span> <span class="string">used</span> <span class="string">as</span> <span class="string">index.</span>	</span><br><span class="line"><span class="string">Limit</span> <span class="string">Requests</span>	<span class="string">Limit</span> <span class="string">frequency</span> <span class="string">of</span> <span class="string">connections</span> <span class="string">from</span> <span class="string">a</span> <span class="string">client.</span>	<span class="number">0.7</span><span class="number">.20</span>	<span class="string">--without-http_limit_req_module</span></span><br><span class="line"><span class="string">Limit</span> <span class="string">Zone</span>	<span class="string">Limit</span> <span class="string">simultaneous</span> <span class="string">connections</span> <span class="string">from</span> <span class="string">a</span> <span class="string">client.</span> <span class="string">Deprecated</span> <span class="string">in</span> <span class="number">1.1</span><span class="number">.8</span><span class="string">,</span> <span class="string">use</span> <span class="string">Limit</span> <span class="string">Conn</span> <span class="string">Instead.</span>	<span class="number">0.5</span><span class="number">.6</span>	<span class="string">--without-http_limit_zone_module</span></span><br><span class="line"><span class="string">Limit</span> <span class="string">Conn</span>	<span class="string">Limit</span> <span class="string">concurrent</span> <span class="string">connections</span> <span class="string">based</span> <span class="string">on</span> <span class="string">a</span> <span class="string">variable.</span>		<span class="string">--without-http_limit_conn_module</span></span><br><span class="line"><span class="string">Log</span>	<span class="string">Customize</span> <span class="string">access</span> <span class="string">logs.</span>	</span><br><span class="line"><span class="string">Map</span>	<span class="string">Set</span> <span class="string">config</span> <span class="string">variables</span> <span class="string">using</span> <span class="string">arbitrary</span> <span class="string">key/value</span> <span class="string">pairs.</span>	<span class="number">0.3</span><span class="number">.16</span>	<span class="string">--without-http_map_module</span></span><br><span class="line"><span class="string">Memcached</span>	<span class="string">Memcached</span> <span class="string">support.</span>		<span class="string">--without-http_memcached_module</span></span><br><span class="line"><span class="string">Proxy</span>	<span class="string">Proxy</span> <span class="string">to</span> <span class="string">upstream</span> <span class="string">servers.</span>		<span class="string">--without-http_proxy_module</span></span><br><span class="line"><span class="string">Referer</span>	<span class="string">Filter</span> <span class="string">requests</span> <span class="string">based</span> <span class="string">on</span> <span class="string">Referer</span> <span class="string">header.</span>		<span class="string">--without-http_referer_module</span></span><br><span class="line"><span class="string">Rewrite</span>	<span class="string">Request</span> <span class="string">rewriting</span> <span class="string">using</span> <span class="string">regular</span> <span class="string">expressions.</span>		<span class="string">--without-http_rewrite_module</span></span><br><span class="line"><span class="string">SCGI</span>	<span class="string">SCGI</span> <span class="string">protocol</span> <span class="string">support.</span>	<span class="number">0.8</span><span class="number">.42</span>	<span class="string">--without-http_scgi_module</span></span><br><span class="line"><span class="string">Split</span> <span class="string">Clients</span>	<span class="string">Splits</span> <span class="string">clients</span> <span class="string">based</span> <span class="string">on</span> <span class="string">some</span> <span class="string">conditions</span>	<span class="number">0.8</span><span class="number">.37</span>	<span class="string">--without-http_split_clients_module</span></span><br><span class="line"><span class="string">SSI</span>	<span class="string">Server-side</span> <span class="string">includes.</span>		<span class="string">--without-http_ssi_module</span></span><br><span class="line"><span class="string">Upstream</span>	<span class="string">For</span> <span class="string">load-balancing.</span>		<span class="string">--without-http_upstream_ip_hash_module</span> <span class="string">(ip_hash</span> <span class="string">directive</span> <span class="string">only)</span></span><br><span class="line"><span class="string">User</span> <span class="string">ID</span>	<span class="string">Issue</span> <span class="string">identifying</span> <span class="string">cookies.</span>		<span class="string">--without-http_userid_module</span></span><br><span class="line"><span class="string">uWSGI</span>	<span class="string">uWSGI</span> <span class="string">protocol</span> <span class="string">support.</span>	<span class="number">0.8</span><span class="number">.40</span>	<span class="string">--without-http_uwsgi_module</span></span><br><span class="line"><span class="string">X-Accel</span>	<span class="string">X-Sendfile-like</span> <span class="string">module.</span>	</span><br><span class="line"><span class="string">proxy模块中常用的指令时proxy_pass和proxy_cache.</span></span><br><span class="line"></span><br><span class="line"><span class="string">nginx的web缓存功能的主要是由proxy_cache、fastcgi_cache指令集和相关指令集完成，proxy_cache指令负责反向代理缓存后端服务器的静态内容，fastcgi_cache主要用来处理FastCGI动态进程缓存(这里我不是很清楚这两个指令的区别，好像功能上都差不多，尤其后面这句话的意思，是我翻译过来的)。</span></span><br><span class="line"></span><br><span class="line"><span class="string">确认proxy模块安装好后，下面对nginx的配置文件进行设置，重点部分如标红字体所示。</span></span><br><span class="line"></span><br><span class="line"><span class="string">这是我的nginx.conf配置文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">user</span> <span class="string">www-data;</span></span><br><span class="line"><span class="string">worker_processes</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log notice;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid logs/nginx.pid;</span></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line"><span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line"><span class="string">include</span> <span class="string">mime.types;</span></span><br><span class="line"><span class="string">default_type</span> <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line"><span class="string">log_format</span> <span class="string">main</span> <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line"><span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &quot;$host&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#access_log logs/access.log main;</span></span><br><span class="line"></span><br><span class="line"><span class="string">sendfile</span> <span class="string">on;</span></span><br><span class="line"><span class="comment">#tcp_nopush on;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#keepalive_timeout 0;</span></span><br><span class="line"><span class="string">keepalive_timeout</span> <span class="number">65</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Compression Settings</span></span><br><span class="line"><span class="string">gzip</span> <span class="string">on;</span></span><br><span class="line"><span class="string">gzip_http_version</span> <span class="number">1.0</span><span class="string">;</span></span><br><span class="line"><span class="string">gzip_comp_level</span> <span class="number">2</span><span class="string">;</span></span><br><span class="line"><span class="string">gzip_proxied</span> <span class="string">any;</span></span><br><span class="line"><span class="string">gzip_min_length</span> <span class="number">1100</span><span class="string">;</span></span><br><span class="line"><span class="string">gzip_buffers</span> <span class="number">16</span> <span class="string">8k;</span></span><br><span class="line"><span class="string">gzip_types</span> <span class="string">text/plain</span> <span class="string">text/css</span> <span class="string">application/x-javascript</span> <span class="string">text/xml</span> <span class="string">application/xml</span> <span class="string">application/xml+rss</span> <span class="string">text/javascript;</span></span><br><span class="line"><span class="comment"># Some version of IE 6 don&#x27;t handle compression well on some mime-types,</span></span><br><span class="line"><span class="comment"># so just disable for them</span></span><br><span class="line"><span class="string">gzip_disable</span> <span class="string">&quot;MSIE [1-6].(?!.*SV1)&quot;</span><span class="string">;</span></span><br><span class="line"><span class="comment"># Set a vary header so downstream proxies don&#x27;t send cached gzipped</span></span><br><span class="line"><span class="comment"># content to IE6</span></span><br><span class="line"><span class="string">gzip_vary</span> <span class="string">on;</span></span><br><span class="line"><span class="comment">#end gzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cache begin</span></span><br><span class="line"><span class="string">proxy_buffering</span> <span class="string">on;</span></span><br><span class="line"><span class="string">proxy_cache_valid</span> <span class="string">any</span> <span class="string">10m;</span></span><br><span class="line"><span class="string">proxy_cache_path</span> <span class="string">/data/cache</span> <span class="string">levels=1:2</span> <span class="string">keys_zone=my-cache:8m</span> <span class="string">max_size=1000m</span> <span class="string">inactive=600m;</span></span><br><span class="line"><span class="string">proxy_temp_path</span> <span class="string">/data/temp;</span></span><br><span class="line"><span class="string">proxy_buffer_size</span> <span class="string">4k;</span></span><br><span class="line"><span class="string">proxy_buffers</span> <span class="number">100</span> <span class="string">8k;</span></span><br><span class="line"><span class="comment">#cache end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Basic reverse proxy server ##</span></span><br><span class="line"><span class="comment">## Apache (vm02) backend for www.example.com ##</span></span><br><span class="line"><span class="string">upstream</span> <span class="string">apachephp</span> &#123;</span><br><span class="line"><span class="string">server</span> <span class="string">www.quancha.cn:8080;</span> <span class="comment">#Apache1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Start www.quancha.cn ##</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line"><span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line"><span class="string">server_name</span> <span class="string">*.quancha.cn;</span></span><br><span class="line"></span><br><span class="line"><span class="string">access_log</span> <span class="string">logs/quancha.access.log</span> <span class="string">main;</span></span><br><span class="line"><span class="string">error_log</span> <span class="string">logs/quancha.error.log;</span></span><br><span class="line"><span class="string">root</span> <span class="string">html;</span></span><br><span class="line"><span class="string">index</span> <span class="string">index.html</span> <span class="string">index.htm</span> <span class="string">index.php;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## send request back to apache1 ##</span></span><br><span class="line"><span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line"><span class="string">proxy_pass</span> <span class="string">http://apachephp;</span></span><br><span class="line"><span class="string">proxy_cache</span> <span class="string">my-cache;</span></span><br><span class="line"><span class="string">proxy_cache_valid</span> <span class="number">200</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Proxy Settings</span></span><br><span class="line"><span class="string">proxy_redirect</span> <span class="string">off;</span></span><br><span class="line"><span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$host;</span></span><br><span class="line"><span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></span><br><span class="line"><span class="string">proxy_set_header</span> <span class="string">X-Forwarded-For</span> <span class="string">$proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="string">proxy_next_upstream</span> <span class="string">error</span> <span class="string">timeout</span> <span class="string">invalid_header</span> <span class="string">http_500</span> <span class="string">http_502</span> <span class="string">http_503</span> <span class="string">http_504;</span></span><br><span class="line"><span class="string">proxy_max_temp_file_size</span> <span class="number">0</span><span class="string">;</span></span><br><span class="line"><span class="string">proxy_connect_timeout</span> <span class="number">90</span><span class="string">;</span></span><br><span class="line"><span class="string">proxy_send_timeout</span> <span class="number">90</span><span class="string">;</span></span><br><span class="line"><span class="string">proxy_read_timeout</span> <span class="number">90</span><span class="string">;</span></span><br><span class="line"><span class="string">proxy_buffer_size</span> <span class="string">4k;</span></span><br><span class="line"><span class="string">proxy_buffers</span> <span class="number">4</span> <span class="string">32k;</span></span><br><span class="line"><span class="string">proxy_busy_buffers_size</span> <span class="string">64k;</span></span><br><span class="line"><span class="string">proxy_temp_file_write_size</span> <span class="string">64k;</span></span><br><span class="line"><span class="comment">##End Proxy Settings</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## End www.quancha.cn ##</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">配置文件中以proxy_开头的指令我们大都可以字面意思得到理解。请务必注意一点proxy_cache_path和proxy_temp_path设置的目录需要在同一分区，因为它们之间是硬链接的关系。</span></span><br><span class="line"></span><br><span class="line"><span class="string">最后启动nginx，来迎接着激动人心的时刻吧。我已经迫不及待了。如果文章哪里有问题或者你遇到了什么麻烦，可以留言让我知道。</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx屏蔽ip"><a href="#nginx屏蔽ip" class="headerlink" title="nginx屏蔽ip"></a>nginx屏蔽ip</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">采集和防止采集是一个经久不息的话题，一方面都想搞别人的东西，另一方面不想自己的东西被别人搞走。</span></span><br><span class="line"></span><br><span class="line"><span class="string">本文介绍如何利用nginx屏蔽ip来实现防止采集，当然也可以通过iptable来实现。</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.查找要屏蔽的ip</span></span><br><span class="line"><span class="string">awk</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> <span class="string">nginx.access.log</span> <span class="string">|sort</span> <span class="string">|uniq</span> <span class="string">-c|sort</span> <span class="string">-n</span></span><br><span class="line"><span class="string">nginx.access.log</span> <span class="string">为日志文件，</span></span><br><span class="line"></span><br><span class="line"><span class="string">会到如下结果，前面是ip的访问次数，后面是ip，很明显我们需要把访问次数多的ip并且不是蜘蛛的ip屏蔽掉，本例当中我们屏蔽掉165.91.122.67</span></span><br><span class="line"> <span class="string">...</span></span><br><span class="line">  <span class="number">13610</span> <span class="number">202.112</span><span class="number">.113</span><span class="number">.192</span></span><br><span class="line">  <span class="number">95772</span> <span class="number">180.169</span><span class="number">.22</span><span class="number">.135</span></span><br><span class="line"> <span class="number">337418</span> <span class="number">219.220</span><span class="number">.141</span><span class="number">.2</span></span><br><span class="line"> <span class="number">558378</span> <span class="number">165.91</span><span class="number">.122</span><span class="number">.67</span></span><br><span class="line"><span class="number">2</span><span class="string">.在nginx的安装目录下面,新建屏蔽ip文件，命名为blockip.conf，以后新增加屏蔽ip只需编辑这个文件即可。</span> <span class="string">加入如下内容</span></span><br><span class="line"><span class="string">deny</span> <span class="number">165.91</span><span class="number">.122</span><span class="number">.67</span><span class="string">;</span> </span><br><span class="line"><span class="string">保存一下。</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.在nginx的配置文件nginx.conf中加入如下配置，可以放到http,</span> <span class="string">server,</span> <span class="string">location,</span> <span class="string">limit_except语句块，需要注意相对路径，本例当中nginx.conf，blocksip.conf在同一个目录中。</span></span><br><span class="line"><span class="string">include</span> <span class="string">blockip.conf;</span> </span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.重启一下nginx的服务：/usr/local/nginx/nginx</span> <span class="string">-s</span> <span class="string">reload</span> <span class="string">就可以生效了。</span></span><br><span class="line"></span><br><span class="line"><span class="string">高级用法：</span></span><br><span class="line"></span><br><span class="line"><span class="string">屏蔽ip的配置文件既可以屏蔽单个ip，也可以屏蔽ip段，或者只允许某个ip或者某个ip段访问。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 屏蔽单个ip访问</span></span><br><span class="line"><span class="string">deny</span> <span class="string">IP;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许单个ip访问</span></span><br><span class="line"><span class="string">allow</span> <span class="string">IP;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 屏蔽所有ip访问</span></span><br><span class="line"><span class="string">deny</span> <span class="string">all;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许所有ip访问</span></span><br><span class="line"><span class="string">allow</span> <span class="string">all;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#屏蔽整个段即从123.0.0.1到123.255.255.254访问的命令</span></span><br><span class="line"><span class="string">deny</span> <span class="number">123.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#屏蔽IP段即从123.45.0.1到123.45.255.254访问的命令</span></span><br><span class="line"><span class="string">deny</span> <span class="number">124.45</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#屏蔽IP段即从123.45.6.1到123.45.6.254访问的命令</span></span><br><span class="line"><span class="string">deny</span> <span class="number">123.45</span><span class="number">.6</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果你想实现这样的应用，除了几个IP外，其他全部拒绝，</span></span><br><span class="line"><span class="string">那需要你在blockip.conf中这样写</span></span><br><span class="line"><span class="string">allow</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">;</span> </span><br><span class="line"><span class="string">allow</span> <span class="number">1.1</span><span class="number">.1</span><span class="number">.2</span><span class="string">;</span></span><br><span class="line"><span class="string">deny</span> <span class="string">all;</span> </span><br><span class="line"><span class="string">单独网站屏蔽IP的方法，把include</span> <span class="string">blocksip.conf;</span> <span class="string">放到网址对应的在server&#123;&#125;语句块，</span></span><br><span class="line"><span class="string">所有网站屏蔽IP的方法，把include</span> <span class="string">blocksip.conf;</span> <span class="string">放到http</span> &#123;&#125;<span class="string">语句块。</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx-“403-Forbidden”-错误"><a href="#nginx-“403-Forbidden”-错误" class="headerlink" title="nginx “403 Forbidden” 错误"></a>nginx “403 Forbidden” 错误</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">nginx</span> <span class="string">的</span> <span class="number">403</span> <span class="string">Forbidden</span> <span class="string">errors</span> <span class="string">表示你在请求一个资源文件但是nginx不允许你查看。</span></span><br><span class="line"><span class="number">403</span> <span class="string">Forbidden</span> <span class="string">只是一个HTTP状态码，像404,200一样不是技术上的错误。</span></span><br><span class="line"><span class="string">哪些场景需要返回403状态码的场景？</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.网站禁止特定的用户访问所有内容，例：网站屏蔽某个ip访问。</span></span><br><span class="line"><span class="number">2</span><span class="string">.访问禁止目录浏览的目录，例：设置autoindex</span> <span class="string">off后访问目录。</span></span><br><span class="line"><span class="number">3</span><span class="string">.用户访问只能被内网访问的文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">以上几种常见的需要返回</span> <span class="number">403</span> <span class="string">Forbidden</span> <span class="string">的场景。</span></span><br><span class="line"></span><br><span class="line"><span class="string">由于服务器端的错误配置导致在不希望nginx返回403时返回403</span> <span class="string">Forbidden。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.权限配置不正确</span></span><br><span class="line"></span><br><span class="line"><span class="string">这个是nginx出现403</span> <span class="string">forbidden最常见的原因。</span></span><br><span class="line"></span><br><span class="line"><span class="string">为了保证文件能正确执行，nginx既需要文件的读权限,又需要文件所有父目录的可执行权限。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例如，当访问/usr/local/nginx/html/image.jpg时，nginx既需要image.jpg文件的可读权限，也需要/,/usr,/usr/local,/usr/local/nginx,/usr/local/nginx/html的可以执行权限。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法:设置所有父目录为755权限，设置文件为644权限可以避免权限不正确。</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.目录索引设置错误（index指令配置）</span></span><br><span class="line"></span><br><span class="line"><span class="string">网站根目录不包含index指令设置的文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例如，运行PHP的网站，通常像这样配置index</span></span><br><span class="line"></span><br><span class="line"><span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm</span> <span class="string">index.php;</span></span><br><span class="line"></span><br><span class="line"><span class="string">当访问该网站的时，nginx</span> <span class="string">会按照</span> <span class="string">index.html，index.htm</span> <span class="string">，index.php</span> <span class="string">的先后顺序在根目录中查找文件。如果这三个文件都不存在，那么nginx就会返回403</span> <span class="string">Forbidden。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果index中不定义</span> <span class="string">index.php</span> <span class="string">，nginx直接返回403</span> <span class="string">Forbidden而不会去检查index.php是否存在。</span></span><br><span class="line"></span><br><span class="line"><span class="string">同样对于如果运行jsp,</span> <span class="string">py时也需要添加index.jsp,index.py到目录索引指令index中。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法:添加首页文件到index指令，常见的是index.php，index.jsp，index.jsp或者自定义首页文件。</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx-File-not-found-错误"><a href="#nginx-File-not-found-错误" class="headerlink" title="nginx File not found 错误"></a>nginx File not found 错误</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">使用php-fpm解析PHP，&quot;No</span> <span class="string">input</span> <span class="string">file</span> <span class="string">specified&quot;，&quot;File</span> <span class="string">not</span> <span class="string">found&quot;是令nginx新手头疼的常见错误，原因是php-fpm进程找不到SCRIPT_FILENAME配置的要执行的.php文件，php-fpm返回给nginx的默认404错误提示。</span></span><br><span class="line"></span><br><span class="line"><span class="string">比如我的网站doucument_root下没有test.php，访问这个文件时通过抓包可以看到返回的内容。</span></span><br><span class="line"></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">404</span> <span class="string">Not</span> <span class="string">Found</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Fri,</span> <span class="number">21</span> <span class="string">Dec</span> <span class="number">2012 08:15:28 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html</span></span><br><span class="line"><span class="attr">Proxy-Connection:</span> <span class="string">close</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">nginx/1.2.5</span></span><br><span class="line"><span class="attr">X-Powered-By:</span> <span class="string">PHP/5.4.7</span></span><br><span class="line"><span class="attr">Via:</span> <span class="number">1.1</span> <span class="string">c3300</span> <span class="string">(NetCache</span> <span class="string">NetApp/6.0.7)</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="string">File</span> <span class="string">not</span> <span class="string">found.</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">很多人不想用户直接看到这个默认的404错误信息，想自定义404错误.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">给出解决办法前我们来先分析下如何避免出现这类404错误，然后再说真的遇到这种情况(比如用户输入一个错误不存在的路径)时该怎么办，才能显示自定义的404错误页。</span></span><br><span class="line"></span><br><span class="line"><span class="string">一、错误的路径被发送到php-fpm进程</span></span><br><span class="line"><span class="string">出现这类错误，十个有九个是后端fastcgi进程收到错误路径(SCRIPT_FILENAME)，而后端fastcgi收到错误路径的原因大都是配置错误。</span></span><br><span class="line"></span><br><span class="line"><span class="string">常见的nginx.conf的配置如下：</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">listen</span>   [<span class="string">::</span>]<span class="string">:80;</span></span><br><span class="line">    <span class="string">server_name</span>  <span class="string">example.com</span> <span class="string">www.example.com;</span></span><br><span class="line">    <span class="string">access_log</span>  <span class="string">/var/www/logs/example.com.access.log;</span>  </span><br><span class="line"> </span><br><span class="line">    <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">        <span class="string">root</span>   <span class="string">/var/www/example.com;</span></span><br><span class="line">        <span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm</span> <span class="string">index.pl;</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="string">location</span> <span class="string">/images</span> &#123;</span><br><span class="line">        <span class="string">autoindex</span> <span class="string">on;</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="string">location</span> <span class="string">~</span> <span class="string">.php$</span> &#123;</span><br><span class="line">        <span class="string">fastcgi_pass</span>   <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000;</span></span><br><span class="line">        <span class="string">fastcgi_index</span>  <span class="string">index.php;</span></span><br><span class="line">        <span class="string">fastcgi_param</span>  <span class="string">SCRIPT_FILENAME</span>  <span class="string">/var/www/example.com$fastcgi_script_name;</span></span><br><span class="line">        <span class="string">include</span> <span class="string">fastcgi_params;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">这个配置中有很多不合理的地方，其中一个明显的问题就是root指令被放到了location</span> <span class="string">/</span> <span class="string">块。如果root指令被定义在location块中那么该root指令只能对其所在的location生效。其它locaiont中没有root指令，像location</span> <span class="string">/images块不会匹配任何请求，需要在每个请求中重复配置root指令来解决这个问题。因此我们需要把root指令放在server块，这样各个location就会继承父server块定义的$document_root，如果某个location需要定义一个不同的$document_root，则可以在location单独定义一个root指令。</span></span><br><span class="line"></span><br><span class="line"><span class="string">另一个问题就是fastCGI参数SCRIPT_FILENAME</span> <span class="string">是写死的。如果修改了root指令的值或者移动文件到别的目录，php-fpm会返回“No</span> <span class="string">input</span> <span class="string">file</span> <span class="string">specified”错误，因为SCRIPT_FILENAME在配置中是写死的并没有随着$doucument_root变化而变化，我们可以修改SCRIPT_FILENAME配置如下：</span></span><br><span class="line"></span><br><span class="line"><span class="string">fastcgi_param</span>  <span class="string">SCRIPT_FILENAME</span>  <span class="string">$document_root$fastcgi_script_name;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">所以我们不能忘记在server块中配置root指令，不然$document_root的值为空，只会传$fastcgi_script_name到php-fpm，这样就会导致“No</span> <span class="string">input</span> <span class="string">file</span> <span class="string">specified”错误。</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">二、请求的文件真的不存在</span></span><br><span class="line"><span class="string">当nginx收到一个不在的.php文件的请求时,因为nginx只会检查$uri是否是.php结尾，不会对文件是否存在进行判断，.php结尾的请求nginx会直接发给php-fpm处理。php-fpm处理时找不到文件就会返回“No</span> <span class="string">input</span> <span class="string">file</span> <span class="string">specified”带着“404</span> <span class="string">Not</span> <span class="string">Found”头。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法</span></span><br><span class="line"><span class="string">我们在nginx拦截不存在的文件，请求并返回自定义404错误</span></span><br><span class="line"></span><br><span class="line"><span class="string">使用</span> <span class="string">try_files</span> <span class="string">捕捉不存在的urls并返回错误。</span></span><br><span class="line"><span class="string">location</span> <span class="string">~</span> <span class="string">.php$</span> &#123;</span><br><span class="line"> <span class="string">try_files</span> <span class="string">$uri</span> <span class="string">=404;</span></span><br><span class="line"> <span class="string">fastcgi_pass</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000;</span></span><br><span class="line"> <span class="string">fastcgi_index</span> <span class="string">index.php;</span></span><br><span class="line"> <span class="string">fastcgi_param</span> <span class="string">SCRIPT_FILENAME</span> <span class="string">....</span></span><br><span class="line"> <span class="string">...................................</span></span><br><span class="line"> <span class="string">...................................</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">上面的配置会检查.php文件是否存在，如果不存在，会返回404页面。</span></span><br></pre></td></tr></table></figure>



<h1 id="nginx将POST数据写到日志里"><a href="#nginx将POST数据写到日志里" class="headerlink" title="nginx将POST数据写到日志里"></a>nginx将POST数据写到日志里</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">NGINX</span> <span class="string">是一个强大的web服务器，可以很容易的应对高负载的HTTP流量。nginx每处理一个连接，就会记录一条日志信息，包括诸如：IP地址，回复内容大小、http状态码等信息。</span></span><br><span class="line"></span><br><span class="line"><span class="string">某种情况下，需要了解请求内容是什么，特别</span> <span class="string">POST</span> <span class="string">请求。</span> <span class="string">NGINX</span> <span class="string">默认只支持记录GET请求，对于记录POST请求需要使用额外的模块，例如，</span> <span class="string">Echo</span> <span class="string">module,</span> <span class="string">这个模块提供很多有用的指令:</span> <span class="string">echo,</span> <span class="string">time,</span> <span class="string">and</span> <span class="string">sleep。</span></span><br><span class="line"></span><br><span class="line"><span class="string">记录POST请求我们需要使用到其中的</span> <span class="string">echo_read_request_body</span> <span class="string">命令和</span> <span class="string">$request_body</span> <span class="string">变量。</span></span><br><span class="line"></span><br><span class="line"><span class="string">源码编译nginx增加echo模块步骤:</span></span><br><span class="line"><span class="number">1</span><span class="string">.下载nginx和echo模块的源码：</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-L</span> <span class="string">-O</span> <span class="string">&#x27;https://github.com/openresty/echo-nginx-module/archive/v0.61.tar.gz&#x27;</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-xzvf</span> <span class="string">v0.61.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">v0.61.tar.gz</span></span><br><span class="line"><span class="string">mv</span> <span class="string">echo-nginx-module-0.61</span> <span class="string">/tmp/echo-nginx-module</span></span><br><span class="line"><span class="string">wget</span> <span class="string">https://www.openssl.org/source/openssl-1.1.1g.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">openssl-1.1.1g.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">openssl-1.1.1g.tar.gz</span></span><br><span class="line"><span class="string">mv</span> <span class="string">openssl-1.1.1g</span> <span class="string">/tmp/openssl-1.1.1g</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-O</span> <span class="string">&#x27;http://nginx.org/download/nginx-1.18.0.tar.gz&#x27;</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-xzvf</span> <span class="string">nginx-1.18.0.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">nginx-1.18.0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.创建</span> <span class="string">nginx</span> <span class="string">用户，</span> <span class="string">用来运行nginx进程：</span></span><br><span class="line"><span class="string">groupadd</span> <span class="string">nginx</span></span><br><span class="line"><span class="string">useradd</span> <span class="string">-g</span> <span class="string">nginx</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.从源码编译安装nginx：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">nginx-1.18.0/</span> <span class="string">&amp;&amp;</span> <span class="string">./configure</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--user=nginx</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--group=nginx</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--prefix=/usr/local/nginx</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-http_gzip_static_module</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-http_stub_status_module</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-http_ssl_module</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-pcre</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-file-aio</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-http_realip_module</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--with-openssl=/tmp/openssl-1.1.1g</span> <span class="string">\</span></span><br><span class="line"> <span class="string">--add-module=/tmp/echo-nginx-module</span></span><br><span class="line"> </span><br><span class="line"><span class="string">make</span> <span class="string">-j2</span></span><br><span class="line"><span class="string">make</span> <span class="string">install</span></span><br><span class="line"> </span><br><span class="line"><span class="string">现在，nginx已安装完成，可以启动了。启动之前我们需要修改nginx的默认配置文件</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span>  <span class="string">来记录</span> <span class="string">HTTP</span> <span class="string">request</span> <span class="string">body</span> <span class="string">到日志文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">NGINX</span> <span class="string">使用</span> <span class="string">access_log</span> <span class="string">指令记录多种</span> <span class="string">HTTP</span> <span class="string">请求相关的信息，哪些信息会或不会被记录则通过</span> <span class="string">log_format</span> <span class="string">指令来设置。Echo</span> <span class="string">模块通过调用</span> <span class="string">echo_read_request_body</span> <span class="string">方法存储</span> <span class="string">request</span> <span class="string">body</span> <span class="string">到</span> <span class="string">request_body</span> <span class="string">变量中。为了记录</span> <span class="string">POST</span> <span class="string">请求体需要在配置文件中修改这些指令:</span></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line"> <span class="string">...</span></span><br><span class="line"> <span class="string">log_format</span> <span class="string">custom</span> <span class="string">&#x27;$request_body&#x27;</span><span class="string">;</span></span><br><span class="line"> <span class="string">access_log</span> <span class="string">logs/access.log</span> <span class="string">custom;</span></span><br><span class="line"> <span class="string">...</span></span><br><span class="line"> <span class="string">server</span> &#123;</span><br><span class="line">  <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">   <span class="string">echo_read_request_body;</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  &#125; </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">如果你的系统负载很高，你可以通过提高Linux打开文件数参数的大小来提高</span> <span class="string">NGINX</span> <span class="string">的处理能力。通过如下指令增加配置到文件末尾或直接修改相应的配置文件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;fs.file-max = 1073741824&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/sysctl.conf</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;nginx soft nofile 40960&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/security/limits.conf</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;nginx hard nofile 81920&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/security/limits.conf</span></span><br><span class="line"><span class="string">终于可以启动nginx并记录POST的请求内容了，运行nginx命令：</span></span><br><span class="line"></span><br><span class="line"><span class="string">/usr/local/nginx/sbin/nginx</span></span><br><span class="line"><span class="string">测试</span></span><br><span class="line"><span class="string">修改配置文件增加上面提到的三个配置。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">nginx</span>]<span class="comment"># cd /usr/local/nginx/conf/</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># vi nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">测试并重新加载配置文件</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># /usr/local/nginx/sbin/nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx:</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">file</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span> <span class="string">syntax</span> <span class="string">is</span> <span class="string">ok</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx:</span> <span class="string">configuration</span> <span class="string">file</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span> <span class="string">test</span> <span class="string">is</span> <span class="string">successful</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># /usr/local/nginx/sbin/nginx -s reload</span></span><br><span class="line"></span><br><span class="line"><span class="string">不带post参数会记录一个短横</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">conf</span>]<span class="comment"># cd ../logs/</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">logs</span>]<span class="comment"># tail -f access.log </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">logs</span>]<span class="comment"># curl -d &quot;site=redis.com.cn&quot; 127.0.0.1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@67</span> <span class="string">logs</span>]<span class="comment"># tail -f access.log </span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="string">site=redis.com.cn</span></span><br><span class="line"></span><br><span class="line"><span class="string">排错</span></span><br><span class="line"><span class="number">1</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">getaddrinfo()</span> <span class="string">...</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">configuring</span> <span class="string">additional</span> <span class="string">modules</span></span><br><span class="line"></span><br><span class="line"><span class="string">adding</span> <span class="string">module</span> <span class="string">in</span> <span class="string">/tmp/echo-nginx-module</span></span><br><span class="line"></span><br><span class="line"><span class="string">/tmp/echo-nginx-module/config:</span> <span class="attr">line 41:</span> [<span class="string">:</span> <span class="type">!=:</span> <span class="string">unary</span> <span class="string">operator</span> <span class="string">expected</span></span><br><span class="line"></span><br><span class="line"> <span class="string">+</span> <span class="string">ngx_http_echo_module</span> <span class="string">was</span> <span class="string">configured</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/usr/local/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/usr/include/pcre/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/usr/pkg/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/opt/local/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">./configure:</span> <span class="attr">error:</span> <span class="string">the</span> <span class="string">HTTP</span> <span class="string">rewrite</span> <span class="string">module</span> <span class="string">requires</span> <span class="string">the</span> <span class="string">PCRE</span> <span class="string">library.</span></span><br><span class="line"></span><br><span class="line"><span class="string">You</span> <span class="string">can</span> <span class="string">either</span> <span class="string">disable</span> <span class="string">the</span> <span class="string">module</span> <span class="string">by</span> <span class="string">using</span> <span class="string">--without-http_rewrite_module</span></span><br><span class="line"></span><br><span class="line"><span class="string">option</span>, <span class="string">or</span> <span class="string">install</span> <span class="string">the</span> <span class="string">PCRE</span> <span class="string">library</span> <span class="string">into</span> <span class="string">the</span> <span class="string">system</span>, <span class="string">or</span> <span class="string">build</span> <span class="string">the</span> <span class="string">PCRE</span> <span class="string">library</span></span><br><span class="line"></span><br><span class="line"><span class="string">statically</span> <span class="string">from</span> <span class="string">the</span> <span class="string">source</span> <span class="string">with</span> <span class="string">nginx</span> <span class="string">by</span> <span class="string">using</span> <span class="string">--with-pcre=&lt;path&gt;</span> <span class="string">option.</span></span><br><span class="line"></span><br><span class="line"><span class="string">缺少PCRE、ZLIB参考nginx安装教程先安装对应的源码包</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">OpenSSL</span> <span class="string">library</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">OpenSSL</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/usr/local/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">OpenSSL</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/usr/pkg/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">checking</span> <span class="string">for</span> <span class="string">OpenSSL</span> <span class="string">library</span> <span class="string">in</span> <span class="string">/opt/local/</span> <span class="string">...</span> <span class="string">not</span> <span class="string">found</span></span><br><span class="line"></span><br><span class="line"><span class="string">需要下载opensll包，参考nginx安装</span></span><br><span class="line"></span><br><span class="line"><span class="string">cd</span> <span class="string">/tmp</span></span><br><span class="line"><span class="string">wget</span> <span class="string">https://www.openssl.org/source/openssl-1.1.1g.tar.gz</span></span><br><span class="line"><span class="string">tar</span> <span class="string">-zxvf</span> <span class="string">openssl-1.1.1g.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="string">--with-openssl=/tmp/openssl-1.1.1g</span></span><br><span class="line"></span><br><span class="line"><span class="string">总结，本文主要介绍了如果配置nginx的日志记录功能，以及如何编译、安装、和使用echo模块。</span></span><br><span class="line"></span><br><span class="line"><span class="string">参考：developers.redhat.com/blog/2016/05/23/configuring-nginx-to-log-post-data-on-linux-rhel/</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="归海一刀 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="归海一刀 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/18/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%8F%8AIDE/" rel="prev" title="开发工具软件及IDE">
      <i class="fa fa-chevron-left"></i> 开发工具软件及IDE
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%8A%9F%E8%83%BD%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">Nginx功能概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">Nginx安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="nav-number">3.</span> <span class="nav-text">nginx基本配置与参数说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%92%8C%E6%8E%A7%E5%88%B6nginx"><span class="nav-number">3.1.</span> <span class="nav-text">运行和控制nginx</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="nav-number">4.</span> <span class="nav-text">nginx反向代理配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-location%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="nav-number">5.</span> <span class="nav-text">nginx location匹配规则</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-upstream-%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">nginx upstream 配置和作用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-rewrite-%E6%8C%87%E4%BB%A4"><span class="nav-number">7.</span> <span class="nav-text">nginx rewrite 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx-rewrite%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%EF%BC%9A"><span class="nav-number">7.0.1.</span> <span class="nav-text">nginx rewrite指令执行顺序：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#break%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.2.</span> <span class="nav-text">break指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.3.</span> <span class="nav-text">if指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#return%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.4.</span> <span class="nav-text">return指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rewrite%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.5.</span> <span class="nav-text">rewrite指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rewrite-log%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.6.</span> <span class="nav-text">rewrite_log指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.7.</span> <span class="nav-text">set指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#uninitialized-variable-warn%E6%8C%87%E4%BB%A4"><span class="nav-number">7.0.8.</span> <span class="nav-text">uninitialized_variable_warn指令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E5%8A%9F%E8%83%BD%EF%BC%88nginx%E5%A4%9A%E7%AB%99%E7%82%B9%EF%BC%8C%E7%BB%91%E5%AE%9A%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">nginx的虚拟主机功能（nginx多站点，绑定多个域名）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA-%E7%BA%AF%E9%9D%99%E6%80%81-html-%E6%94%AF%E6%8C%81-Two-Virtual-Hosts-Serving-Static-Files"><span class="nav-number">8.1.</span> <span class="nav-text">两个虚拟主机(纯静态-html 支持) - Two Virtual Hosts, Serving Static Files</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8nginx%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">9.</span> <span class="nav-text">如何使用nginx配置负载均衡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8nginx%E7%9A%84proxy-cache%E5%81%9A%E7%BD%91%E7%AB%99%E7%BC%93%E5%AD%98"><span class="nav-number">10.</span> <span class="nav-text">使用nginx的proxy_cache做网站缓存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E5%B1%8F%E8%94%BDip"><span class="nav-number">11.</span> <span class="nav-text">nginx屏蔽ip</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-%E2%80%9C403-Forbidden%E2%80%9D-%E9%94%99%E8%AF%AF"><span class="nav-number">12.</span> <span class="nav-text">nginx “403 Forbidden” 错误</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-File-not-found-%E9%94%99%E8%AF%AF"><span class="nav-number">13.</span> <span class="nav-text">nginx File not found 错误</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E5%B0%86POST%E6%95%B0%E6%8D%AE%E5%86%99%E5%88%B0%E6%97%A5%E5%BF%97%E9%87%8C"><span class="nav-number">14.</span> <span class="nav-text">nginx将POST数据写到日志里</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">归海一刀</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/DJPY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;DJPY" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dj.player.2020@gmail.com" title="E-Mail → mailto:dj.player.2020@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.djplayer.top/" title="http:&#x2F;&#x2F;www.djplayer.top" rel="noopener" target="_blank">曾经的网站(域名过期)</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">归海一刀</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>
    <script defer src="/lib/three/canvas_sphere.min.js"></script>


  















  

  

</body>
</html>
